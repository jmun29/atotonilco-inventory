<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Atotonilco ‚Äî Inventory System v4</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  const SUPABASE_URL  = 'https://xbczzyrsugfwpiwqnynq.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiY3p6eXJzdWdmd3Bpd3FueW5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzY2NjEsImV4cCI6MjA4NzQ1MjY2MX0.1QDqXPift-ZUj-zQhex0HvOUCUJfpWQat0gybji9DwM';
  const AUDIT_PIN = '2123';
</script>
<style>
:root{
  --bg:#1a1a18;--surface:#242420;--surface2:#2e2e29;--surface3:#383832;
  --border:#4a4a42;--accent:#f5a623;--accent-dark:#c47d0e;
  --green:#4caf7d;--green-dark:#2d7a52;--blue:#5b9bd5;--red:#e05c5c;--purple:#9b6de8;
  --text:#f5f2eb;--text2:#c8c4b8;--text3:#8a8678;--radius:10px;
  --font-display:'Nunito',sans-serif;--font-body:'Nunito Sans',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:16px;line-height:1.6;min-height:100vh;padding-bottom:40px;}

/* PIN LOCK */
#lock-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;}
#lock-screen.hidden{display:none;}
.lock-logo{font-family:var(--font-display);font-size:36px;font-weight:900;color:var(--accent);letter-spacing:2px;margin-bottom:6px;}
.lock-sub{font-size:15px;color:var(--text3);font-weight:600;margin-bottom:40px;}
.lock-icon{font-size:56px;margin-bottom:24px;}
.pin-dots{display:flex;gap:16px;margin-bottom:32px;}
.pin-dot{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);background:transparent;transition:all 0.2s;}
.pin-dot.filled{background:var(--accent);border-color:var(--accent);}
.pin-dot.error{background:var(--red);border-color:var(--red);}
.pin-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;width:100%;max-width:300px;}
.pin-key{background:var(--surface);border:2px solid var(--border);border-radius:12px;color:var(--text);font-family:var(--font-display);font-size:26px;font-weight:800;padding:18px;cursor:pointer;transition:all 0.15s;text-align:center;-webkit-tap-highlight-color:transparent;user-select:none;}
.pin-key:active{background:var(--accent);color:#000;transform:scale(0.94);}
.pin-key.del{font-size:20px;color:var(--text3);}
.pin-key.empty{background:none;border:none;cursor:default;}
.pin-error-msg{margin-top:20px;font-size:15px;font-weight:700;color:var(--red);min-height:24px;text-align:center;}
.pin-hint{margin-top:24px;font-size:13px;color:var(--text3);text-align:center;line-height:1.5;}

/* HEADER */
.app-header{background:var(--surface);border-bottom:2px solid var(--accent);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.app-title{font-family:var(--font-display);font-size:22px;font-weight:900;color:var(--accent);letter-spacing:1px;line-height:1.1;}
.app-subtitle{font-size:13px;color:var(--text3);font-weight:600;}
.header-right{display:flex;align-items:center;gap:10px;}
.sync-indicator{font-size:12px;font-weight:700;padding:4px 10px;border-radius:20px;border:1px solid var(--border);color:var(--text3);}
.sync-indicator.ok{border-color:var(--green);color:var(--green);}
.sync-indicator.err{border-color:var(--red);color:var(--red);}
.sync-indicator.syncing{border-color:var(--accent);color:var(--accent);}
.lock-btn{background:var(--surface2);border:2px solid var(--border);border-radius:8px;color:var(--text3);font-size:20px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.lang-toggle{display:flex;background:var(--surface2);border:2px solid var(--border);border-radius:50px;padding:3px;gap:2px;}
.lang-btn{background:none;border:none;color:var(--text3);font-family:var(--font-display);font-size:14px;font-weight:800;padding:6px 14px;border-radius:50px;cursor:pointer;transition:all 0.2s;}
.lang-btn.active{background:var(--accent);color:#000;}

/* TABS */
.tab-bar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.tab-bar::-webkit-scrollbar{display:none;}
.tab-item{flex:1;min-width:62px;background:none;border:none;border-bottom:3px solid transparent;color:var(--text3);font-family:var(--font-display);font-size:11px;font-weight:800;padding:11px 4px 9px;cursor:pointer;transition:all 0.2s;text-align:center;white-space:nowrap;-webkit-tap-highlight-color:transparent;}
.tab-item.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-item .tab-icon{font-size:18px;display:block;margin-bottom:2px;}

/* MAIN */
.main{padding:16px;max-width:700px;margin:0 auto;}
.panel{display:none;}.panel.active{display:block;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:16px;}
.card-title{font-family:var(--font-display);font-size:17px;font-weight:800;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;}

/* FORMS */
.form-group{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
.form-group label{font-size:14px;font-weight:700;color:var(--text2);}
.form-group input,.form-group select,.form-group textarea{background:var(--surface2);border:2px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font-body);font-size:17px;font-weight:600;padding:12px 14px;outline:none;transition:border-color 0.15s;width:100%;-webkit-appearance:none;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent);background:var(--surface3);}
.form-group select{cursor:pointer;}.form-group textarea{resize:vertical;min-height:80px;}
input[readonly]{color:var(--accent)!important;border-color:var(--accent-dark)!important;background:var(--surface3)!important;cursor:default;}
.form-row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}

/* INGREDIENT ROW */
.ing-row{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:10px;}
.ing-row-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.ing-name{font-family:var(--font-display);font-size:15px;font-weight:800;color:var(--text);}
.ing-unit-badge{font-size:12px;font-weight:700;color:var(--accent);background:var(--surface3);border:1px solid var(--accent-dark);border-radius:20px;padding:2px 10px;}

/* GROUP SELECTOR */
.group-selector{background:var(--surface2);border:2px solid var(--accent-dark);border-radius:10px;padding:14px;margin-bottom:16px;}
.group-selector-label{font-size:12px;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.group-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:800;margin-right:6px;margin-bottom:4px;}
.group-badge.A{background:#1a3a2a;color:var(--green);border:1px solid var(--green);}
.group-badge.B{background:#1a2a3a;color:var(--blue);border:1px solid var(--blue);}
.group-badge.C{background:#2a1a3a;color:var(--purple);border:1px solid var(--purple);}

/* SILO MULTI-SELECT */
.silo-row{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;}
.silo-entry{background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:8px;flex:1;min-width:140px;}
.silo-entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;font-size:12px;font-weight:800;color:var(--accent);}
.btn-add-silo{background:none;border:1px dashed var(--border);border-radius:8px;color:var(--text3);font-size:13px;font-weight:700;padding:8px;cursor:pointer;width:100%;margin-top:6px;}
.btn-add-silo:hover{border-color:var(--accent);color:var(--accent);}

/* DIVIDERS */
.section-divider{border:none;border-top:1px solid var(--border);margin:16px 0;}
.section-label{font-size:12px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ITEM ENTRIES */
.item-entry{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;}
.item-entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.item-num{font-family:var(--font-display);font-size:13px;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:1px;}
.remove-btn{background:none;border:1px solid var(--border);border-radius:6px;color:var(--red);font-size:18px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

/* BUTTONS */
.btn{display:block;width:100%;background:var(--accent);color:#000;border:none;border-radius:10px;font-family:var(--font-display);font-size:18px;font-weight:800;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center;margin-top:6px;-webkit-tap-highlight-color:transparent;}
.btn:active{transform:scale(0.98);}.btn:hover{background:var(--accent-dark);color:#fff;}
.btn-secondary{background:var(--surface2);border:2px solid var(--border);color:var(--text2);font-size:16px;}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);background:var(--surface2);}
.btn-green{background:var(--green);color:#000;}.btn-green:hover{background:var(--green-dark);color:#fff;}
.btn-blue{background:var(--blue);color:#fff;}.btn-blue:hover{background:#3a6fa8;}
.btn-add-item{background:none;border:2px dashed var(--border);border-radius:10px;color:var(--text3);font-family:var(--font-display);font-size:16px;font-weight:700;padding:14px;cursor:pointer;width:100%;transition:all 0.2s;margin-bottom:12px;}
.btn-add-item:hover{border-color:var(--accent);color:var(--accent);}
.btn-row{display:flex;gap:10px;margin-top:8px;}.btn-row .btn{flex:2;}.btn-row .btn-secondary{flex:1;}

/* SUMMARY */
.summary-box{background:var(--surface2);border:2px solid var(--accent-dark);border-radius:10px;padding:16px;margin-top:16px;}
.summary-title{font-family:var(--font-display);font-size:14px;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:16px;}
.summary-row:last-child{border-bottom:none;}
.summary-row span:first-child{color:var(--text2);font-weight:600;}
.summary-row span:last-child{color:var(--accent);font-weight:800;}

/* LOG TABLE */
.log-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:var(--radius);border:1px solid var(--border);}
.log-table{width:100%;border-collapse:collapse;font-size:14px;min-width:500px;}
.log-table th{background:var(--surface2);color:var(--text2);font-family:var(--font-display);font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:0.8px;padding:11px 12px;text-align:left;border-bottom:2px solid var(--border);white-space:nowrap;}
.log-table td{padding:11px 12px;border-bottom:1px solid var(--border);color:var(--text2);vertical-align:middle;font-weight:600;}
.log-table tr:last-child td{border-bottom:none;}.log-table tr:hover td{background:var(--surface2);}
.log-table td:first-child{color:var(--text);font-weight:700;}
.item-tag{display:inline-block;background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:12px;font-weight:700;color:var(--text2);margin:2px;white-space:nowrap;}
.item-tag.accent{border-color:var(--accent-dark);color:var(--accent);}
.item-tag.green{border-color:var(--green-dark);color:var(--green);}
.item-tag.red{border-color:var(--red);color:var(--red);}

/* STATS */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center;}
.stat-value{font-family:var(--font-display);font-size:30px;font-weight:900;color:var(--accent);line-height:1;margin-bottom:4px;}
.stat-label{font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;}

/* INVENTORY BARS */
.inv-item{display:flex;align-items:center;gap:10px;padding:12px 0;border-bottom:1px solid var(--border);}
.inv-item:last-child{border-bottom:none;}
.inv-name{font-size:15px;font-weight:700;color:var(--text);flex:1;}
.inv-qty{font-family:var(--font-display);font-size:18px;font-weight:900;min-width:90px;text-align:right;}
.inv-qty.ok{color:var(--green);}.inv-qty.low{color:var(--accent);}.inv-qty.critical{color:var(--red);}
.inv-bar-wrap{width:60px;height:8px;background:var(--surface3);border-radius:4px;overflow:hidden;}
.inv-bar{height:100%;border-radius:4px;transition:width 0.4s;}
.inv-bar.ok{background:var(--green);}.inv-bar.low{background:var(--accent);}.inv-bar.critical{background:var(--red);}

/* EXPORT */
.export-option{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:12px;}
.export-title{font-family:var(--font-display);font-size:17px;font-weight:800;color:var(--text);margin-bottom:6px;}
.export-desc{font-size:14px;color:var(--text3);margin-bottom:14px;line-height:1.5;}
.export-btn-row{display:flex;gap:8px;flex-wrap:wrap;}
.export-btn{background:var(--green);color:#000;border:none;border-radius:8px;font-family:var(--font-display);font-size:14px;font-weight:800;padding:10px 18px;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.export-btn:hover{background:var(--green-dark);color:#fff;}
.export-btn.blue{background:var(--blue);color:#fff;}.export-btn.blue:hover{background:#3a6fa8;}
.date-range-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:14px;flex-wrap:wrap;}
.date-range-row .form-group{flex:1;min-width:130px;margin-bottom:0;}

/* FILTER */
.filter-bar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.filter-btn{background:var(--surface2);border:2px solid var(--border);border-radius:8px;color:var(--text3);font-family:var(--font-display);font-size:13px;font-weight:800;padding:8px 16px;cursor:pointer;transition:all 0.15s;}
.filter-btn.active{background:var(--accent);color:#000;border-color:var(--accent);}

/* EMPTY */
.empty-state{text-align:center;padding:40px 24px;color:var(--text3);}
.empty-icon{font-size:44px;margin-bottom:10px;}.empty-text{font-size:17px;font-weight:700;}.empty-sub{font-size:14px;margin-top:6px;}

/* LOADING */
#loading-overlay{position:fixed;inset:0;background:rgba(26,26,24,0.85);z-index:8000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
#loading-overlay.hidden{display:none;}
.loading-spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
.loading-text{font-family:var(--font-display);font-size:16px;font-weight:800;color:var(--text2);}
@keyframes spin{to{transform:rotate(360deg);}}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--green);color:#000;font-family:var(--font-display);font-size:16px;font-weight:800;padding:14px 28px;border-radius:50px;opacity:0;transition:all 0.3s;z-index:9998;white-space:nowrap;box-shadow:0 4px 24px rgba(0,0,0,0.5);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:5000;display:flex;align-items:flex-end;justify-content:center;}
.modal-overlay.hidden{display:none;}
.modal-sheet{background:var(--surface);border-radius:18px 18px 0 0;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;padding:24px 18px 40px;-webkit-overflow-scrolling:touch;}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.modal-title{font-family:var(--font-display);font-size:20px;font-weight:900;color:var(--accent);}
.modal-close{background:var(--surface2);border:2px solid var(--border);border-radius:8px;color:var(--text3);font-size:22px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.modal-btn-row{display:flex;gap:10px;margin-top:20px;}
.modal-btn-row .btn{flex:2;margin-top:0;}
.btn-delete{flex:1;background:var(--red);color:#fff;border:none;border-radius:10px;font-family:var(--font-display);font-size:16px;font-weight:800;padding:16px;cursor:pointer;}
.btn-delete:active{transform:scale(0.98);}
.modal-section{font-size:12px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin:16px 0 10px;display:flex;align-items:center;gap:8px;}
.modal-section::after{content:'';flex:1;height:1px;background:var(--border);}
.btn-edit-row{background:var(--surface3);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:13px;font-weight:700;padding:5px 11px;cursor:pointer;font-family:var(--font-display);}
.btn-edit-row:active{background:var(--accent);color:#000;}
.btn-del-row{background:none;border:1px solid var(--border);border-radius:6px;color:var(--red);font-size:15px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

/* WAREHOUSE */
.warehouse-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;}
.warehouse-product{font-family:var(--font-display);font-size:17px;font-weight:800;color:var(--text);margin-bottom:8px;}
.warehouse-date-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:14px;}
.warehouse-date-row:last-child{border-bottom:none;}
.warehouse-qty{font-family:var(--font-display);font-size:16px;font-weight:900;}
.warehouse-qty.positive{color:var(--green);}
.warehouse-qty.zero{color:var(--text3);}
.stock-bar-wrap{width:80px;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-right:8px;}
.stock-bar{height:100%;border-radius:3px;}
.stock-bar.ok{background:var(--green);}.stock-bar.low{background:var(--accent);}.stock-bar.critical{background:var(--red);}

/* AUDIT LOG */
.audit-pin-gate{text-align:center;padding:48px 24px;}
.audit-pin-icon{font-size:52px;margin-bottom:12px;}
.audit-pin-title{font-family:var(--font-display);font-size:22px;font-weight:900;color:var(--accent);margin-bottom:6px;}
.audit-pin-sub{font-size:14px;color:var(--text3);margin-bottom:28px;}
.audit-pin-dots{display:flex;gap:14px;justify-content:center;margin-bottom:24px;}
.audit-pin-dot{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);background:transparent;transition:all 0.2s;}
.audit-pin-dot.filled{background:var(--blue);border-color:var(--blue);}
.audit-pin-dot.error{background:var(--red);border-color:var(--red);}
.audit-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:280px;margin:0 auto;}
.audit-key{background:var(--surface);border:2px solid var(--border);border-radius:12px;color:var(--text);font-family:var(--font-display);font-size:24px;font-weight:800;padding:16px;cursor:pointer;transition:all 0.15s;-webkit-tap-highlight-color:transparent;}
.audit-key:active{background:var(--blue);color:#fff;transform:scale(0.94);}
.audit-key.del{font-size:18px;color:var(--text3);}
.audit-key.empty{background:none;border:none;cursor:default;}
.audit-pin-err{margin-top:14px;font-size:14px;font-weight:700;color:var(--red);min-height:22px;}
.audit-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:800;letter-spacing:0.5px;}
.audit-badge.edited{background:#1a3a5c;color:var(--blue);border:1px solid var(--blue);}
.audit-badge.deleted{background:#3a1a1a;color:var(--red);border:1px solid var(--red);}
.audit-lock-btn{background:var(--surface2);border:2px solid var(--border);border-radius:8px;color:var(--text3);font-size:13px;font-weight:700;padding:6px 14px;cursor:pointer;font-family:var(--font-display);}

.btn-edit-row{background:var(--surface3);border:1px solid var(--border);border-radius:6px;color:var(--blue);font-size:14px;padding:5px 9px;cursor:pointer;}
.btn-edit-row:active{opacity:0.7;}
.item-tag.red{background:#3a1a1a;color:var(--red);border:1px solid var(--red);}
.item-tag.green{background:#1a3a2a;color:var(--green);border:1px solid var(--green);}
.item-tag.accent{background:#2a1e0a;color:var(--accent);border:1px solid var(--accent-dark);}
.modal-section{font-family:var(--font-display);font-size:13px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin:14px 0 8px;}
.modal-btn-row{display:flex;gap:10px;margin-top:18px;}
.modal-btn-row .btn{flex:1;}
.btn-delete{background:var(--red);color:#fff;border:none;border-radius:10px;font-family:var(--font-display);font-size:15px;font-weight:800;padding:14px;cursor:pointer;}
.btn-delete:active{opacity:0.7;}
/* PHASE 2 PLACEHOLDER */
.phase2-placeholder{background:var(--surface2);border:2px dashed var(--border);border-radius:10px;padding:24px;text-align:center;color:var(--text3);}
.phase2-placeholder .p2-icon{font-size:36px;margin-bottom:8px;}
.phase2-placeholder .p2-title{font-family:var(--font-display);font-size:16px;font-weight:800;color:var(--text2);margin-bottom:4px;}
.phase2-placeholder .p2-sub{font-size:13px;line-height:1.5;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loading-text">Connecting to database‚Ä¶</div>
</div>

<!-- PIN LOCK -->
<div id="lock-screen" class="hidden">
  <div class="lock-logo">ATOTONILCO</div>
  <div class="lock-sub" id="lock-subtitle">Inventory System</div>
  <div class="lock-icon">üîí</div>
  <div class="pin-dots">
    <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
    <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
  </div>
  <div class="pin-keypad">
    <button class="pin-key" onclick="pinPress('1')">1</button><button class="pin-key" onclick="pinPress('2')">2</button><button class="pin-key" onclick="pinPress('3')">3</button>
    <button class="pin-key" onclick="pinPress('4')">4</button><button class="pin-key" onclick="pinPress('5')">5</button><button class="pin-key" onclick="pinPress('6')">6</button>
    <button class="pin-key" onclick="pinPress('7')">7</button><button class="pin-key" onclick="pinPress('8')">8</button><button class="pin-key" onclick="pinPress('9')">9</button>
    <div class="pin-key empty"></div><button class="pin-key" onclick="pinPress('0')">0</button><button class="pin-key del" onclick="pinDel()">‚å´</button>
  </div>
  <div class="pin-error-msg" id="pin-error"></div>
  <div class="pin-hint" id="pin-hint"><span data-i18n="pinHint">Enter your 4-digit PIN<br>Default: 1234 ‚Äî change in Settings</span></div>
</div>

<!-- APP -->
<div id="app-content" style="display:none;">
  <header class="app-header">
    <div>
      <div class="app-title">ATOTONILCO</div>
      <div class="app-subtitle" data-i18n="appSubtitle">Inventory System v4</div>
    </div>
    <div class="header-right">
      <div class="sync-indicator" id="sync-indicator">‚è≥ Connecting</div>
      <button class="lock-btn" onclick="lockApp()">üîí</button>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('en')" id="btn-en">EN</button>
        <button class="lang-btn" onclick="setLang('es')" id="btn-es">ES</button>
      </div>
    </div>
  </header>

  <nav class="tab-bar">
    <button class="tab-item active" onclick="showTab('dash')" id="tab-dash"><span class="tab-icon">üìä</span><span data-i18n="tabDash">Dashboard</span></button>
    <button class="tab-item" onclick="showTab('log')" id="tab-log"><span class="tab-icon">üìã</span><span data-i18n="tabLog">Log Run</span></button>
    <button class="tab-item" onclick="showTab('batch')" id="tab-batch"><span class="tab-icon">üß™</span><span data-i18n="tabBatch">Batching</span></button>
    <button class="tab-item" onclick="showTab('ship')" id="tab-ship"><span class="tab-icon">üöö</span><span data-i18n="tabShip">Ship</span></button>
    <button class="tab-item" onclick="showTab('warehouse')" id="tab-warehouse"><span class="tab-icon">üè≠</span><span data-i18n="tabWarehouse">Warehouse</span></button>
    <button class="tab-item" onclick="showTab('receive')" id="tab-receive"><span class="tab-icon">üì¶</span><span data-i18n="tabReceive">Receive</span></button>
    <button class="tab-item" onclick="showTab('history')" id="tab-history"><span class="tab-icon">üïò</span><span data-i18n="tabHistory">History</span></button>
    <button class="tab-item" onclick="showTab('export')" id="tab-export"><span class="tab-icon">üì§</span><span data-i18n="tabExport">Export</span></button>
    <button class="tab-item" onclick="showTab('settings')" id="tab-settings"><span class="tab-icon">‚öôÔ∏è</span><span data-i18n="tabSettings">Settings</span></button>
    <button class="tab-item" onclick="showTab('audit')" id="tab-audit" style="display:none;"><span class="tab-icon">üîç</span><span data-i18n="tabAudit">Audit</span></button>
  </nav>

  <main class="main">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel active" id="panel-dash">
      <!-- Discrepancy Warning (hidden until audit logs exist) -->
      <div id="dash-discrepancy-banner" style="display:none;background:#3a1a1a;border:2px solid var(--red);border-radius:10px;padding:14px 16px;margin-bottom:14px;">
        <div style="font-family:var(--font-display);font-size:15px;font-weight:800;color:var(--red);margin-bottom:6px;">‚ö†Ô∏è Warehouse Discrepancies Logged</div>
        <div id="dash-discrepancy-list" style="font-size:13px;color:var(--text2);line-height:1.8;"></div>
        <button onclick="showTab('warehouse')" style="margin-top:8px;background:var(--red);color:#fff;border:none;border-radius:8px;font-family:var(--font-display);font-size:13px;font-weight:800;padding:7px 16px;cursor:pointer;">View in Warehouse ‚Üí</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="stat-total-cases">‚Äî</div><div class="stat-label" data-i18n="statCasesWeek">Cases This Week</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-runs">‚Äî</div><div class="stat-label" data-i18n="statRunsWeek">Runs This Week</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-flour-used">‚Äî</div><div class="stat-label" data-i18n="statFlourUsed">Flour Used (lbs)</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-flour-ratio">‚Äî</div><div class="stat-label" data-i18n="statAvgRatio">Avg lbs/Case</div></div>
      </div>
      <div class="card">
        <div class="card-title">üì¶ <span data-i18n="dashFGTitle">Finished Goods ‚Äî Cases by Product (This Week)</span></div>
        <div id="dash-fg-table"></div>
      </div>
      <div class="card">
        <div class="card-title">üïò <span data-i18n="dashRecentRuns">Recent Runs</span></div>
        <div id="recent-runs-list"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOG RUN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-log">
      <div class="card">
        <div class="card-title">üìã <span data-i18n="logRunTitle">Log Production Run</span></div>
        <div class="form-row-2">
          <div class="form-group"><label><span data-i18n="labelDate">Date</span></label><input type="date" id="run-date"></div>
          <div class="form-group"><label><span data-i18n="labelShift">Shift</span></label>
            <select id="run-shift">
              <option value="morning" data-i18n-opt="shiftMorning">Morning</option>
              <option value="afternoon" data-i18n-opt="shiftAfternoon">Afternoon</option>
              <option value="night" data-i18n-opt="shiftNight">Night</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label><span data-i18n="labelOperator">Operator</span></label><input type="text" id="run-operator" placeholder="‚Äî"></div>

        <hr class="section-divider">
        <div class="section-label"><span data-i18n="itemsProducedLabel">Items Produced This Run</span></div>
        <div id="items-container"></div>
        <button class="btn-add-item" onclick="addItem()"><span data-i18n="addItem">+ Add Item</span></button>

        <hr class="section-divider">
        <!-- PRODUCT GROUP SELECTOR -->
        <div class="group-selector">
          <div class="group-selector-label"><span data-i18n="groupSelectorLabel">Ingredient Group for This Run</span></div>
          <div class="form-group" style="margin-bottom:8px;">
            <select id="run-group" onchange="updateIngredientGroup()">
              <option value=""><span data-i18n="selectGroup">‚Äî Select Group ‚Äî</span></option>
              <option value="A">Group A ‚Äî Burrito #2, #3, #3.5, #4, #6</option>
              <option value="B">Group B ‚Äî Burrito #1, #8, Harina, Authentico, Baby, Tonys, Mi Barrio</option>
              <option value="C">Group C ‚Äî Trigo #8, Baja</option>
            </select>
          </div>
          <div id="group-desc" style="font-size:13px;color:var(--text3);line-height:1.5;"></div>
        </div>

        <div class="section-label"><span data-i18n="ingredientsUsed">Ingredients Used</span></div>
        <div id="ing-fields">
          <div class="empty-state" style="padding:20px;">
            <div class="empty-icon" style="font-size:28px;">‚òùÔ∏è</div>
            <div class="empty-text" style="font-size:14px;">Select a product group above</div>
          </div>
        </div>

        <div class="summary-box" id="run-summary-box">
          <div class="summary-title"><span data-i18n="runSummary">Run Summary</span></div>
          <div class="summary-row"><span><span data-i18n="totalCases">Total Cases</span></span><span id="sum-cases">‚Äî</span></div>
          <div class="summary-row"><span><span data-i18n="totalFlour">Total Flour</span></span><span id="sum-flour">‚Äî</span></div>
          <div class="summary-row"><span><span data-i18n="flourPerCase">Flour / Case</span></span><span id="sum-ratio">‚Äî</span></div>
        </div>
        <div class="form-group" style="margin-top:14px;"><label><span data-i18n="labelNotes">Notes</span></label><textarea id="run-notes" placeholder="‚Äî"></textarea></div>
        <div class="btn-row">
          <button class="btn" onclick="saveRun()"><span data-i18n="saveRun">Save Run</span></button>
          <button class="btn btn-secondary" onclick="clearRun()"><span data-i18n="clearBtn">Clear</span></button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORMULA BATCHING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-batch">
      <div class="card">
        <div class="card-title">üß™ <span data-i18n="batchTitle">Formula Batching</span></div>
        <p style="font-size:14px;color:var(--text3);margin-bottom:16px;line-height:1.5;"><span data-i18n="batchDesc">Pre-mix ingredients for later use in production runs. Each batch is logged here and becomes available in Log Run (Group A).</span></p>

        <!-- Sub-Batch 1: Chemicals -->
        <div class="section-label"><span data-i18n="subBatch1">Sub-Batch 1 ‚Äî Chemical Batch</span></div>
        <div class="form-row-2">
          <div class="form-group"><label data-i18n="batchDateLabel">Date of Batching</label><input type="date" id="batch1-date"></div>
          <div class="form-group"><label data-i18n="totalCasesCreated">Total Cases Created</label><input type="number" inputmode="numeric" id="batch1-cases" placeholder="0"></div>
        </div>
        <div class="ing-row">
          <div class="ing-row-header"><span class="ing-name" data-i18n="b1CalciumP">Calcium Propionate</span><span class="ing-unit-badge" data-i18n="b150lbBags">50lb Bags</span></div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="bagsUsed">Bags Used</label><input type="number" inputmode="decimal" id="b1-calcium-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="b1-calcium-lot" placeholder="LOT-XXXX"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-row-header"><span class="ing-name" data-i18n="b1SodiumP">Sodium Propionate</span><span class="ing-unit-badge" data-i18n="b150lbBags">50lb Bags</span></div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="bagsUsed">Bags Used</label><input type="number" inputmode="decimal" id="b1-sodium-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="b1-sodium-lot" placeholder="LOT-XXXX"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-row-header"><span class="ing-name" data-i18n="b1BakingP">Baking Powder</span><span class="ing-unit-badge" data-i18n="b150lbBags">50lb Bags</span></div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="bagsUsed">Bags Used</label><input type="number" inputmode="decimal" id="b1-baking-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="b1-baking-lot" placeholder="LOT-XXXX"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-row-header"><span class="ing-name" data-i18n="b1Salt">Salt</span><span class="ing-unit-badge" data-i18n="b150lbBags">50lb Bags</span></div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="bagsUsed">Bags Used</label><input type="number" inputmode="decimal" id="b1-salt-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="b1-salt-lot" placeholder="LOT-XXXX"></div>
          </div>
        </div>
        <div class="form-group"><label>Notes</label><input type="text" id="batch1-notes" placeholder="‚Äî"></div>
        <button class="btn btn-green" onclick="saveBatch1()"><span data-i18n="saveChemBatch">üíæ Save Chemical Batch</span></button>

        <hr class="section-divider" style="margin-top:24px;">

        <!-- Sub-Batch 2: FGE Blend -->
        <div class="section-label"><span data-i18n="subBatch2">Sub-Batch 2 ‚Äî FGE Blend</span></div>
        <p style="font-size:13px;color:var(--text3);margin-bottom:12px;"><span data-i18n="fgeRatio">1 set of these ingredients = 1 FGE Blend bag.</span></p>
        <div class="form-row-2">
          <div class="form-group"><label data-i18n="batchDateLabel">Date of Batching</label><input type="date" id="batch2-date"></div>
          <div class="form-group"><label data-i18n="numBagsMade">Number of Bags Made</label><input type="number" inputmode="numeric" id="batch2-bags-made" placeholder="0"></div>
        </div>
        <div class="ing-row">
          <div class="ing-row-header"><span class="ing-name" data-i18n="b2Fumaric">Fumaric Acid</span><span class="ing-unit-badge">Bags Used</span></div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="bagsUsed">Bags Used</label><input type="number" inputmode="decimal" id="b2-fumaric-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="b2-fumaric-lot" placeholder="LOT-XXXX"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-row-header"><span class="ing-name" data-i18n="b2Guar">Guar Gum</span><span class="ing-unit-badge">Bags Used</span></div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="bagsUsed">Bags Used</label><input type="number" inputmode="decimal" id="b2-guar-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="b2-guar-lot" placeholder="LOT-XXXX"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-row-header"><span class="ing-name" data-i18n="b2Enzyme">Enzyme Blend</span><span class="ing-unit-badge">Bags Used</span></div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="bagsUsed">Bags Used</label><input type="number" inputmode="decimal" id="b2-enzyme-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="b2-enzyme-lot" placeholder="LOT-XXXX"></div>
          </div>
        </div>
        <div class="form-group"><label>Notes</label><input type="text" id="batch2-notes" placeholder="‚Äî"></div>
        <button class="btn btn-green" onclick="saveBatch2()"><span data-i18n="saveFGEBatch">üíæ Save FGE Blend Batch</span></button>
      </div>

      <!-- Batch History -->
      <div class="card">
        <div class="card-title">üìã <span data-i18n="recentBatches">Recent Batches</span></div>
        <div id="batch-history-list"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHIPPING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-ship">
      <div class="card">
        <div class="card-title">üöö <span data-i18n="shipTitle">Log Shipment</span></div>
        <div class="form-row-2">
          <div class="form-group"><label>Date of Shipment</label><input type="date" id="ship-date"></div>
          <div class="form-group"><label><span data-i18n="shipRecipient">Recipient / Destination</span></label><input type="text" id="ship-recipient" placeholder="‚Äî"></div>
        </div>
        <div class="form-group"><label><span data-i18n="shipPO">Reference / PO #</span></label><input type="text" id="ship-po" placeholder="‚Äî"></div>

        <hr class="section-divider">
        <div class="section-label"><span data-i18n="itemsShipped">Items Shipped</span></div>
        <div id="ship-items-container"></div>
        <button class="btn-add-item" onclick="addShipItem()"><span data-i18n="addShipItem">+ Add Item to Shipment</span></button>

        <div class="form-group" style="margin-top:8px;"><label>Notes</label><textarea id="ship-notes" placeholder="‚Äî" style="min-height:60px;"></textarea></div>
        <button class="btn btn-blue" onclick="saveShipment()"><span data-i18n="saveShipment">üöö Save Shipment</span></button>
      </div>

      <!-- Shipment History -->
      <div class="card">
        <div class="card-title">üìã <span data-i18n="shipHistory">Shipment History</span></div>
        <div class="filter-bar">
          <button class="filter-btn active" onclick="setShipFilter('all',this)"><span data-i18n="filterAll">All</span></button>
          <button class="filter-btn" onclick="setShipFilter('today',this)"><span data-i18n="filterToday">Today</span></button>
          <button class="filter-btn" onclick="setShipFilter('week',this)"><span data-i18n="filterWeek">This Week</span></button>
          <button class="filter-btn" onclick="setShipFilter('month',this)"><span data-i18n="filterMonth">This Month</span></button>
        </div>
        <div class="log-wrapper">
          <table class="log-table">
            <thead><tr>
              <th data-i18n="colDate">Date</th><th data-i18n="shipRecipient">Recipient</th><th data-i18n="colItems">Items</th><th data-i18n="totalCases">Total Cases</th><th></th>
            </tr></thead>
            <tbody id="ship-history-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WAREHOUSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-warehouse">
      <div class="card">
        <div class="card-title" style="justify-content:space-between;">
          <span>üè≠ <span data-i18n="warehouseTitle">Warehouse ‚Äî Available Stock</span></span>
          <button class="export-btn" onclick="exportWarehouse()" style="font-size:13px;padding:7px 14px;">üì• Export</button>
        </div>
        <p style="font-size:13px;color:var(--text3);margin-bottom:14px;line-height:1.5;"><span data-i18n="warehouseDesc">Formula: Cases Produced on Date X ‚àí Total Shipped from Date X = Available Stock. Grouped by product then production date (FIFO order).</span></p>
        <div class="filter-bar">
          <button class="filter-btn active" onclick="setWarehouseView('all',this)"><span data-i18n="allProducts">All Products</span></button>
          <button class="filter-btn" onclick="setWarehouseView('instock',this)"><span data-i18n="inStockOnly">In Stock Only</span></button>
        </div>
        <div id="warehouse-grid"></div>
      </div>

      <div class="card">
        <div class="card-title">üîé Warehouse Audit ‚Äî Physical Count</div>
        <p style="font-size:13px;color:var(--text3);margin-bottom:14px;line-height:1.5;">Enter the actual physical count for a product+date. If it differs from the system balance, provide a reason and the system will log the adjustment.</p>
        <div class="form-row-2">
          <div class="form-group"><label>Product</label>
            <select id="audit-product" onchange="loadAuditDates()">
              <option value="">‚Äî Select Product ‚Äî</option>
            </select>
          </div>
          <div class="form-group"><label>Production Date</label>
            <select id="audit-prod-date" onchange="showAuditSystemBalance()">
              <option value="">‚Äî Select product first ‚Äî</option>
            </select>
          </div>
        </div>
        <div id="audit-system-balance" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;font-size:14px;color:var(--text3);display:none;">
          <span style="font-weight:800;color:var(--text);">System Balance: </span><span id="audit-system-qty" style="color:var(--accent);font-weight:800;font-size:18px;">‚Äî</span> cases
        </div>
        <div class="form-row-2">
          <div class="form-group"><label>Actual Physical Count (cases)</label><input type="number" inputmode="numeric" id="audit-physical-count" placeholder="0" oninput="showAuditDiff()"></div>
          <div class="form-group"><label>Audited By</label><input type="text" id="audit-by" placeholder="Your name"></div>
        </div>
        <div id="audit-diff-display" style="display:none;padding:10px;border-radius:8px;margin-bottom:12px;font-weight:700;font-size:15px;"></div>
        <div class="form-group" id="audit-reason-group" style="display:none;">
          <label>Reason for Discrepancy ‚òÖ</label>
          <input type="text" id="audit-reason" placeholder="e.g. Damaged cases, counting error, transfer not logged‚Ä¶">
        </div>
        <button class="btn btn-green" onclick="saveWarehouseAudit()">‚úÖ Save Audit / Adjustment</button>
      </div>

      <div class="card">
        <div class="card-title">üìã Recent Audit Adjustments</div>
        <div id="warehouse-audit-log"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECEIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-receive">
      <div class="card">
        <div class="card-title">üì¶ <span data-i18n="receiveTitle">Receive Inventory</span></div>
        <div class="form-row-2">
          <div class="form-group"><label>Date</label><input type="date" id="recv-date"></div>
          <div class="form-group"><label><span data-i18n="labelSupplier">Supplier</span></label><input type="text" id="recv-supplier" placeholder="‚Äî"></div>
        </div>
        <div class="form-group"><label><span data-i18n="labelPO">PO / Reference #</span></label><input type="text" id="recv-po" placeholder="‚Äî"></div>
        <hr class="section-divider">
        <div class="section-label"><span data-i18n="itemsReceived">Items Received</span></div>

        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingFlour">Flour</div>
          <div class="form-row-3">
            <div class="form-group"><label data-i18n="labelLbs">lbs</label><input type="number" inputmode="decimal" id="recv-flour-lbs" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelBags">Bags</label><input type="number" inputmode="numeric" id="recv-flour-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-flour-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingWWFlourLabel">Whole Wheat Flour</div>
          <div class="form-row-3">
            <div class="form-group"><label data-i18n="labelLbs">lbs</label><input type="number" inputmode="decimal" id="recv-ww-lbs" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelBags">Bags</label><input type="number" inputmode="numeric" id="recv-ww-bags" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-ww-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingOilLabel">Oil (50 lb case)</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="labelCases">Cases</label><input type="number" inputmode="decimal" id="recv-oil" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-oil-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingBetaLabel">Beta Tablets</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="labelTablets">Tablets</label><input type="number" inputmode="numeric" id="recv-beta" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-beta-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingGorditaLabel">Gordita Bags</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="labelBags">Bags</label><input type="number" inputmode="numeric" id="recv-gordita" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-gordita-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingSaltLabel">Salt</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="label50lbBags">50lb Bags</label><input type="number" inputmode="decimal" id="recv-salt" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-salt-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingBakingPLabel">Baking Powder</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="label50lbBags">50lb Bags</label><input type="number" inputmode="decimal" id="recv-bakingp" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-bakingp-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingCalciumLabel">Calcium Propionate</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="label50lbBags">50lb Bags</label><input type="number" inputmode="decimal" id="recv-calcium" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-calcium-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingSodiumPLabel">Sodium Propionate</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="label50lbBags">50lb Bags</label><input type="number" inputmode="decimal" id="recv-sodiump" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-sodiump-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingFumaricLabel">Fumaric Acid</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="labelBags">Bags</label><input type="number" inputmode="decimal" id="recv-fumaric" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-fumaric-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingEnzymeLabel">Enzyme Blend</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="labelBags">Bags</label><input type="number" inputmode="decimal" id="recv-enzyme" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-enzyme-lot" placeholder="LOT"></div>
          </div>
        </div>
        <div class="ing-row">
          <div class="ing-name" style="margin-bottom:10px;" data-i18n="ingGuarLabel">Guar Gum</div>
          <div class="form-row-2">
            <div class="form-group"><label data-i18n="labelBags">Bags</label><input type="number" inputmode="decimal" id="recv-guar" placeholder="0"></div>
            <div class="form-group"><label data-i18n="labelLot">Lot #</label><input type="text" id="recv-guar-lot" placeholder="LOT"></div>
          </div>
        </div>

        <div class="form-group" style="margin-top:8px;"><label><span data-i18n="otherItemsReceived">Other Items Received</span></label><textarea id="recv-other" placeholder="Item, qty, lot#‚Ä¶"></textarea></div>
        <div class="form-group"><label>Notes</label><input type="text" id="recv-notes" placeholder="‚Äî"></div>
        <button class="btn btn-green" onclick="saveReceival()"><span data-i18n="saveReceipt">Save Receipt</span></button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-history">
      <div class="card">
        <div class="card-title">üïò <span data-i18n="prodHistory">Production History</span></div>
        <div class="filter-bar" id="hist-filter-bar">
          <button class="filter-btn active" onclick="setHistFilter('all',this)">All</button>
          <button class="filter-btn" onclick="setHistFilter('today',this)">Today</button>
          <button class="filter-btn" onclick="setHistFilter('week',this)">This Week</button>
          <button class="filter-btn" onclick="setHistFilter('month',this)">This Month</button>
        </div>
        <div class="log-wrapper">
          <table class="log-table"><thead><tr>
            <th data-i18n="colDate">Date</th><th data-i18n="colShift">Shift</th><th data-i18n="colOperator">Operator</th><th data-i18n="colGroup">Group</th>
            <th data-i18n="colItems">Items</th><th data-i18n="colCases">Cases</th><th data-i18n="colFlourLbs">Flour (lbs)</th><th data-i18n="colLbsCase">lbs/case</th><th></th>
          </tr></thead><tbody id="history-body"></tbody></table>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üß™ Formula Batch History</div>
        <div class="filter-bar" id="batch-hist-filter-bar">
          <button class="filter-btn active" onclick="setBatchHistFilter('all',this)">All</button>
          <button class="filter-btn" onclick="setBatchHistFilter('week',this)">This Week</button>
          <button class="filter-btn" onclick="setBatchHistFilter('month',this)">This Month</button>
        </div>
        <div class="log-wrapper">
          <table class="log-table"><thead><tr>
            <th>Date</th><th>Type</th><th>Qty Created</th><th>Key Ingredients</th><th>Notes</th><th></th>
          </tr></thead><tbody id="batch-hist-body"></tbody></table>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üöö Shipping History</div>
        <div class="filter-bar" id="ship-hist-filter-bar">
          <button class="filter-btn active" onclick="setShipHistFilter('all',this)">All</button>
          <button class="filter-btn" onclick="setShipHistFilter('today',this)">Today</button>
          <button class="filter-btn" onclick="setShipHistFilter('week',this)">This Week</button>
          <button class="filter-btn" onclick="setShipHistFilter('month',this)">This Month</button>
        </div>
        <div class="log-wrapper">
          <table class="log-table"><thead><tr>
            <th>Date</th><th>Recipient</th><th>Items Shipped</th><th>Total Cases</th><th></th>
          </tr></thead><tbody id="ship-hist-body"></tbody></table>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üì¶ <span data-i18n="receiptHistory">Receipt History</span></div>
        <div class="log-wrapper">
          <table class="log-table"><thead><tr>
            <th data-i18n="colDate">Date</th><th data-i18n="labelSupplier">Supplier</th><th data-i18n="colPO">PO #</th><th data-i18n="colFlourLbs">Flour (lbs)</th><th data-i18n="colFlourLot">Flour Lot</th><th></th>
          </tr></thead><tbody id="receipt-body"></tbody></table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-export">
      <div class="card">
        <div class="card-title">üì§ <span data-i18n="exportTitle">Export Data</span></div>
        <p style="color:var(--text2);font-size:14px;margin-bottom:16px;line-height:1.6;"><span data-i18n="exportDesc">Download as Excel (.xlsx). Use date range filters or quick period buttons.</span></p>

        <!-- Date Range -->
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:16px;">
          <div style="font-size:13px;font-weight:800;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;">üìÖ <span data-i18n="dateRangeFilter">Date Range Filter</span></div>
          <div class="date-range-row">
            <div class="form-group"><label><span data-i18n="startDate">Start Date</span></label><input type="date" id="export-start"></div>
            <div class="form-group"><label><span data-i18n="endDate">End Date</span></label><input type="date" id="export-end"></div>
            <button class="export-btn blue" onclick="exportCustomRange()" style="height:fit-content;margin-bottom:0;"><span data-i18n="exportRange">Export Range</span></button>
          </div>
        </div>

        <div class="export-option">
          <div class="export-title">Production Runs</div>
          <div class="export-desc"><span data-i18n="exportRunsDesc">All ingredients, lot numbers, items produced, flour-per-case ratios.</span></div>
          <div class="export-btn-row">
            <button class="export-btn" onclick="exportRuns('today')">üìÖ Today</button>
            <button class="export-btn" onclick="exportRuns('week')">This Week</button>
            <button class="export-btn" onclick="exportRuns('month')">This Month</button>
            <button class="export-btn blue" onclick="exportRuns('all')">All Time</button>
          </div>
        </div>
        <div class="export-option">
          <div class="export-title">Shipments</div>
          <div class="export-desc"><span data-i18n="exportShipmentsDesc">All outbound shipments with products, quantities, and destinations.</span></div>
          <div class="export-btn-row">
            <button class="export-btn" onclick="exportShipments('week')">This Week</button>
            <button class="export-btn" onclick="exportShipments('month')">This Month</button>
            <button class="export-btn blue" onclick="exportShipments('all')">All Time</button>
          </div>
        </div>
        <div class="export-option">
          <div class="export-title">Receipts</div>
          <div class="export-desc"><span data-i18n="exportReceiptsDesc">All incoming deliveries with supplier, lot numbers, and quantities.</span></div>
          <div class="export-btn-row">
            <button class="export-btn" onclick="exportReceipts('month')">This Month</button>
            <button class="export-btn blue" onclick="exportReceipts('all')">All Time</button>
          </div>
        </div>
        <div class="export-option">
          <div class="export-title">Formula Batches</div>
          <div class="export-desc"><span data-i18n="exportBatchesDesc">Chemical batches and FGE blend batches.</span></div>
          <div class="export-btn-row">
            <button class="export-btn blue" onclick="exportBatches('all')">All Time</button>
          </div>
        </div>
        <div class="export-option">
          <div class="export-title">Warehouse Stock</div>
          <div class="export-desc"><span data-i18n="exportWarehouseDesc">Current available stock by product and production date.</span></div>
          <div class="export-btn-row">
            <button class="export-btn blue" onclick="exportWarehouse()">Current Stock</button>
          </div>
        </div>
        <div class="export-option">
          <div class="export-title">Full Report</div>
          <div class="export-desc"><span data-i18n="exportFullDesc">All modules in one Excel file with separate sheets.</span></div>
          <div class="export-btn-row">
            <button class="export-btn" onclick="exportFull('month')">This Month</button>
            <button class="export-btn blue" onclick="exportFull('all')">All Time</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-settings">
      <div class="card">
        <div class="card-title">‚öôÔ∏è <span data-i18n="settingsTitle">Settings</span></div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border);">
          <div><div style="font-size:17px;font-weight:700;"><span data-i18n="changePIN">Change PIN</span></div><div style="font-size:13px;color:var(--text3);"><span data-i18n="changePINSub">Update your 4-digit security PIN</span></div></div>
          <button class="btn btn-secondary" style="width:auto;padding:10px 18px;margin:0;font-size:14px;" onclick="startChangePIN()">Change</button>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border);">
          <div><div style="font-size:17px;font-weight:700;"><span data-i18n="clearAllData">Clear All Local Data</span></div><div style="font-size:13px;color:var(--text3);"><span data-i18n="clearAllDataSub">Does not delete Supabase data</span></div></div>
          <button class="btn" style="width:auto;padding:10px 18px;margin:0;font-size:14px;background:var(--red);color:#fff;" onclick="clearLocalData()">Clear</button>
        </div>

        <!-- Phase 2 Placeholder -->
        <div style="padding:16px 0;border-bottom:1px solid var(--border);">
          <div style="font-size:17px;font-weight:700;margin-bottom:10px;">üë• User Access & Roles</div>
          <div class="phase2-placeholder">
            <div class="p2-icon">üîê</div>
            <div class="p2-title"><span data-i18n="phase2Title">Phase 2 ‚Äî Coming Soon</span></div>
            <div class="p2-sub"><span data-i18n="phase2Sub">Individual user PINs with role-based access:<br>Log Run User ¬∑ Batching User ¬∑ Admin</span></div>
          </div>
        </div>

        <div style="padding:16px 0;">
          <div style="font-size:17px;font-weight:700;">Version</div>
          <div style="font-size:13px;color:var(--text3);cursor:default;" id="version-tap" onclick="versionTap()">v4.1 ‚Äî Feb 2026 ¬∑ inventory-system ¬∑ Supabase enabled</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">‚òÅÔ∏è <span data-i18n="dbStatus">Database Status</span></div>
        <div id="db-status-box" style="font-size:15px;color:var(--text2);line-height:1.7;"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIT LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-audit">
      <div id="audit-gate" class="card audit-pin-gate">
        <div class="audit-pin-icon">üîç</div>
        <div class="audit-pin-title"><span data-i18n="auditTitle">Audit Log</span></div>
        <div class="audit-pin-sub"><span data-i18n="auditPinSub">Enter the audit PIN to continue</span></div>
        <div class="audit-pin-dots">
          <div class="audit-pin-dot" id="adot-0"></div><div class="audit-pin-dot" id="adot-1"></div>
          <div class="audit-pin-dot" id="adot-2"></div><div class="audit-pin-dot" id="adot-3"></div>
        </div>
        <div class="audit-keypad">
          <button class="audit-key" onclick="auditPinPress('1')">1</button><button class="audit-key" onclick="auditPinPress('2')">2</button><button class="audit-key" onclick="auditPinPress('3')">3</button>
          <button class="audit-key" onclick="auditPinPress('4')">4</button><button class="audit-key" onclick="auditPinPress('5')">5</button><button class="audit-key" onclick="auditPinPress('6')">6</button>
          <button class="audit-key" onclick="auditPinPress('7')">7</button><button class="audit-key" onclick="auditPinPress('8')">8</button><button class="audit-key" onclick="auditPinPress('9')">9</button>
          <div class="audit-key empty"></div><button class="audit-key" onclick="auditPinPress('0')">0</button><button class="audit-key del" onclick="auditPinDel()">‚å´</button>
        </div>
        <div class="audit-pin-err" id="audit-pin-err"></div>
      </div>
      <div id="audit-content" style="display:none;">
        <div class="card">
          <div class="card-title" style="justify-content:space-between;">
            <span>üîç Audit Log</span>
            <div style="display:flex;gap:8px;">
              <button class="export-btn" onclick="exportAuditLog()" style="font-size:13px;padding:7px 14px;">üì• Export</button>
              <button class="audit-lock-btn" onclick="lockAuditLog()">üîí Lock</button>
            </div>
          </div>
          <div class="filter-bar">
            <button class="filter-btn active" onclick="setAuditFilter('all',this)">All</button>
            <button class="filter-btn" onclick="setAuditFilter('today',this)">Today</button>
            <button class="filter-btn" onclick="setAuditFilter('week',this)">This Week</button>
            <button class="filter-btn" onclick="setAuditFilter('month',this)">This Month</button>
          </div>
          <div id="audit-summary" style="display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap;"></div>
          <div class="log-wrapper">
            <table class="log-table" style="min-width:700px;">
              <thead><tr>
                <th>Date &amp; Time</th><th>Action</th><th>Record Type</th><th>Record Date</th><th>Changed By</th><th>What Changed</th>
              </tr></thead>
              <tbody id="audit-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </main>
</div><!-- end app-content -->

<!-- ‚ïê‚ïê‚ïê EDIT RUN MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="edit-run-modal">
  <div class="modal-sheet">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Production Run</div>
      <button class="modal-close" onclick="closeEditRun()">‚úï</button>
    </div>
    <input type="hidden" id="edit-run-id">
    <div class="form-row-2">
      <div class="form-group"><label>Date</label><input type="date" id="edit-run-date"></div>
      <div class="form-group"><label>Shift</label>
        <select id="edit-run-shift">
          <option value="morning">Morning</option>
          <option value="afternoon">Afternoon</option>
          <option value="night">Night</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label>Operator</label><input type="text" id="edit-run-operator"></div>
    <div class="form-group"><label>Notes</label><textarea id="edit-run-notes" style="min-height:60px;"></textarea></div>
    <div class="modal-section">Items Produced</div>
    <div id="edit-items-container"></div>
    <button class="btn-add-item" onclick="addEditItem()" style="margin-bottom:12px;">+ Add Item</button>
    <div class="modal-section">Flour Summary</div>
    <div class="form-row-2">
      <div class="form-group"><label>Total Flour (lbs)</label><input type="number" inputmode="decimal" id="edit-flour"></div>
      <div class="form-group"><label>Flour Lot</label><input type="text" id="edit-lot-flour"></div>
    </div>
    <div class="form-group"><label style="color:var(--red);font-weight:800;">‚òÖ Changed By (required)</label><input type="text" id="edit-run-changed-by" placeholder="Your name" style="border-color:var(--blue);"></div>
    <div class="modal-btn-row">
      <button class="btn" onclick="saveEditRun()">üíæ Save Changes</button>
      <button class="btn-delete" onclick="confirmDeleteRun()">üóë Delete</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê EDIT RECEIPT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="edit-receipt-modal">
  <div class="modal-sheet">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Receipt</div>
      <button class="modal-close" onclick="closeEditReceipt()">‚úï</button>
    </div>
    <input type="hidden" id="edit-receipt-id">
    <div class="form-row-2">
      <div class="form-group"><label>Date</label><input type="date" id="edit-recv-date"></div>
      <div class="form-group"><label>Supplier</label><input type="text" id="edit-recv-supplier"></div>
    </div>
    <div class="form-group"><label>PO #</label><input type="text" id="edit-recv-po"></div>
    <div class="form-row-3">
      <div class="form-group"><label>Flour (lbs)</label><input type="number" inputmode="decimal" id="edit-recv-flour-lbs"></div>
      <div class="form-group"><label>Flour Bags</label><input type="number" inputmode="numeric" id="edit-recv-flour-bags"></div>
      <div class="form-group"><label>Flour Lot</label><input type="text" id="edit-recv-flour-lot"></div>
    </div>
    <div class="form-row-2">
      <div class="form-group"><label>Oil (cases)</label><input type="number" inputmode="decimal" id="edit-recv-oil"></div>
      <div class="form-group"><label>Oil Lot</label><input type="text" id="edit-recv-oil-lot"></div>
    </div>
    <div class="form-row-2">
      <div class="form-group"><label>Beta Tablets</label><input type="number" inputmode="numeric" id="edit-recv-beta"></div>
      <div class="form-group"><label>Beta Lot</label><input type="text" id="edit-recv-beta-lot"></div>
    </div>
    <div class="form-group"><label>Other Items</label><textarea id="edit-recv-other" style="min-height:60px;"></textarea></div>
    <div class="form-group"><label>Notes</label><input type="text" id="edit-recv-notes"></div>
    <div class="form-group"><label style="color:var(--red);font-weight:800;">‚òÖ Changed By (required)</label><input type="text" id="edit-recv-changed-by" placeholder="Your name" style="border-color:var(--blue);"></div>
    <div class="modal-btn-row">
      <button class="btn" onclick="saveEditReceipt()">üíæ Save Changes</button>
      <button class="btn-delete" onclick="confirmDeleteReceipt()">üóë Delete</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê EDIT BATCH MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="edit-batch-modal">
  <div class="modal-sheet">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Formula Batch</div>
      <button class="modal-close" onclick="closeEditBatch()">‚úï</button>
    </div>
    <input type="hidden" id="edit-batch-id">
    <input type="hidden" id="edit-batch-type">
    <div class="form-row-2">
      <div class="form-group"><label>Date</label><input type="date" id="edit-batch-date"></div>
      <div id="edit-batch-qty-wrap">
        <!-- filled dynamically based on batch type -->
      </div>
    </div>
    <div id="edit-batch-ings"><!-- ingredient fields inserted here --></div>
    <div class="form-group"><label>Notes</label><input type="text" id="edit-batch-notes"></div>
    <div class="form-group"><label style="color:var(--red);font-weight:800;">‚òÖ Changed By (required)</label>
      <input type="text" id="edit-batch-changed-by" placeholder="Your name" style="border-color:var(--blue);">
    </div>
    <div class="modal-btn-row">
      <button class="btn" onclick="saveEditBatch()">üíæ Save Changes</button>
      <button class="btn-delete" onclick="confirmDeleteBatch()">üóë Delete</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê EDIT SHIPMENT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="edit-ship-modal">
  <div class="modal-sheet">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Shipment</div>
      <button class="modal-close" onclick="closeEditShip()">‚úï</button>
    </div>
    <input type="hidden" id="edit-ship-id">
    <div class="form-row-2">
      <div class="form-group"><label>Date</label><input type="date" id="edit-ship-date"></div>
      <div class="form-group"><label>Recipient / Destination</label><input type="text" id="edit-ship-recipient" placeholder="‚Äî"></div>
    </div>
    <div class="form-group"><label>PO / Reference #</label><input type="text" id="edit-ship-po" placeholder="‚Äî"></div>
    <div class="modal-section">Items Shipped</div>
    <div id="edit-ship-items"><!-- rows inserted here --></div>
    <div class="form-group" style="margin-top:8px;"><label>Notes</label><textarea id="edit-ship-notes" style="min-height:60px;"></textarea></div>
    <div class="form-group"><label style="color:var(--red);font-weight:800;">‚òÖ Changed By (required)</label>
      <input type="text" id="edit-ship-changed-by" placeholder="Your name" style="border-color:var(--blue);">
    </div>
    <div class="modal-btn-row">
      <button class="btn" onclick="saveEditShip()">üíæ Save Changes</button>
      <button class="btn-delete" onclick="confirmDeleteShipFromModal()">üóë Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// SUPABASE API
// ============================================================
const SB = {
  headers: {
    'Content-Type':'application/json',
    'apikey':SUPABASE_ANON,
    'Authorization':'Bearer '+SUPABASE_ANON,
    'Prefer':'return=representation'
  },
  async get(table,params=''){
    const r=await fetch(`${SUPABASE_URL}/rest/v1/${table}?order=created_at.desc${params}`,{headers:this.headers});
    if(!r.ok)throw new Error(await r.text());
    return r.json();
  },
  async insert(table,data){
    const r=await fetch(`${SUPABASE_URL}/rest/v1/${table}`,{method:'POST',headers:this.headers,body:JSON.stringify(data)});
    if(!r.ok)throw new Error(await r.text());
    return r.json();
  },
  async upsert(table,data){
    const r=await fetch(`${SUPABASE_URL}/rest/v1/${table}`,{method:'POST',headers:{...this.headers,'Prefer':'resolution=merge-duplicates,return=representation'},body:JSON.stringify(data)});
    if(!r.ok)throw new Error(await r.text());
    return r.json();
  },
  async update(table,id,data){
    const r=await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`,{method:'PATCH',headers:{...this.headers,'Prefer':'return=representation'},body:JSON.stringify(data)});
    if(!r.ok)throw new Error(await r.text());
    return r.json();
  },
  async delete(table,id){
    const r=await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`,{method:'DELETE',headers:this.headers});
    if(!r.ok)throw new Error(await r.text());
  }
};

// ============================================================
// STATE
// ============================================================
let currentLang='en';
let runs=[], receipts=[], shipments=[], batches=[], auditLogs=[], warehouseAudits=[];
let inventory={flour_lbs:0,oil_cases:0,beta_count:0};
let histFilter='all', shipFilter='all', warehouseView='all', auditFilter='all', batchHistFilter='all', shipHistFilter='all';
let itemCount=0, editItemCount=0, shipItemCount=0, siloCount=0;
let dbConnected=false;
let storedPIN=localStorage.getItem('ato_pin')||'1234';
let pinBuffer='', changingPIN=false, newPINBuffer='';
let auditUnlocked=false, auditPinBuf='';
let _vtaps=0,_vtimer=null;

// ============================================================
// PRODUCTS & GROUPS
// ============================================================
const PRODUCTS=[
  'Burrito #1','Burrito #2','Burrito #3','Burrito #3.5','Burrito #4','Burrito #6','Burrito #8',
  'Trigo #8','Baja 06311 Trigo #10',
  'Harina Especial','Harina Regular','Harina 5.5',
  'Authentico 06 (HE)','Authentico 08 (#8)',
  'Baby 4.0','Baby 4.5','Baby 5.0',
  'Tonys','Mi Barrio','Other / Otro'
];
const GROUP_A=['Burrito #2','Burrito #3','Burrito #3.5','Burrito #4','Burrito #6'];
const GROUP_B=['Burrito #1','Burrito #8','Harina Especial','Harina Regular','Harina 5.5','Harina 5.0','Harina 4.5','Authentico 06 (HE)','Authentico 08 (#8)','Baby 4.0','Baby 4.5','Baby 5.0','Tonys','Mi Barrio'];
const GROUP_C=['Trigo #8','Baja 06311 Trigo #10'];

// ============================================================
// HELPERS
// ============================================================
const g=id=>document.getElementById(id);
const gv=id=>{const el=g(id);return el?(parseFloat(el.value)||0):0;};
const gt=id=>{const el=g(id);return el?el.value.trim():'';};
const egt=id=>{const el=document.getElementById(id);return el?el.value.trim():"";};
const egv=id=>{const el=document.getElementById(id);return el?(parseFloat(el.value)||0):0;};
function showLoading(msg){g('loading-text').textContent=msg||'Saving‚Ä¶';g('loading-overlay').classList.remove('hidden');}
function hideLoading(){g('loading-overlay').classList.add('hidden');}
function showToast(msg,warn){
  const el=g('toast');el.textContent=msg;
  el.style.background=warn?'var(--red)':'var(--green)';
  el.style.color=warn?'#fff':'#000';
  el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3000);
}
function setSyncIndicator(state,text){
  const el=g('sync-indicator');
  el.className='sync-indicator '+(state==='ok'?'ok':state==='err'?'err':'syncing');
  el.textContent=text;
}
function filterByDate(list,f){
  const now=new Date();
  if(f==='all')return list;
  return list.filter(r=>{
    const d=new Date(r.date||r.changed_at||r.created_at);
    if(f==='today')return d.toDateString()===now.toDateString();
    if(f==='week'){const w=new Date(now);w.setDate(w.getDate()-7);return d>=w;}
    if(f==='month')return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
    return true;
  });
}
function filterByRange(list,start,end){
  const s=start?new Date(start):null;
  const e=end?new Date(end+' 23:59:59'):null;
  return list.filter(r=>{
    const d=new Date(r.date||r.created_at);
    if(s&&d<s)return false;
    if(e&&d>e)return false;
    return true;
  });
}
function getLabel(p){const n=new Date();if(p==='today')return n.toISOString().split('T')[0];if(p==='week')return'Week_'+n.toISOString().split('T')[0];if(p==='month')return n.getFullYear()+'_'+String(n.getMonth()+1).padStart(2,'0');return'All';}

// ============================================================
// PIN LOCK
// ============================================================
function pinPress(d){if(changingPIN){handleChangePIN(d);return;}if(pinBuffer.length>=4)return;pinBuffer+=d;updateDots(pinBuffer.length,false);if(pinBuffer.length===4)setTimeout(checkPIN,120);}
function pinDel(){if(changingPIN){newPINBuffer=newPINBuffer.slice(0,-1);updateDots(newPINBuffer.length,false);return;}pinBuffer=pinBuffer.slice(0,-1);updateDots(pinBuffer.length,false);}
function updateDots(count,error){for(let i=0;i<4;i++)document.getElementById('dot-'+i).className='pin-dot'+(i<count?(error?' error':' filled'):'');}
function checkPIN(){if(pinBuffer===storedPIN){g('lock-screen').classList.add('hidden');g('app-content').style.display='block';pinBuffer='';}else{updateDots(4,true);g('pin-error').textContent=t('pinIncorrect');setTimeout(()=>{pinBuffer='';updateDots(0,false);g('pin-error').textContent='';},1200);}}
function lockApp(){pinBuffer='';changingPIN=false;newPINBuffer='';updateDots(0,false);g('pin-error').textContent='';g('lock-screen').classList.remove('hidden');g('app-content').style.display='none';}
function startChangePIN(){changingPIN='new1';newPINBuffer='';g('pin-hint').textContent=t('pinNewPrompt');g('pin-error').textContent='';updateDots(0,false);lockApp();}
function handleChangePIN(d){if(newPINBuffer.length>=4)return;newPINBuffer+=d;updateDots(newPINBuffer.length,false);if(newPINBuffer.length===4){if(changingPIN==='new1'){const first=newPINBuffer;setTimeout(()=>{changingPIN='new2';newPINBuffer='';updateDots(0,false);g('pin-hint').textContent=t('pinConfirmPrompt');window._tmpPIN=first;},200);}else{setTimeout(()=>{if(newPINBuffer===window._tmpPIN){storedPIN=newPINBuffer;localStorage.setItem('ato_pin',storedPIN);changingPIN=false;newPINBuffer='';pinBuffer='';g('lock-screen').classList.add('hidden');g('app-content').style.display='block';showToast(t('pinUpdated'));}else{updateDots(4,true);g('pin-error').textContent=t('pinNoMatch');setTimeout(()=>{changingPIN='new1';newPINBuffer='';updateDots(0,false);g('pin-error').textContent='';g('pin-hint').textContent='Enter your NEW 4-digit PIN';},1400);}},120);}}}

// ============================================================
// TABS & LANG
// ============================================================
function showTab(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-item').forEach(b=>b.classList.remove('active'));
  g('panel-'+id).classList.add('active');
  g('tab-'+id).classList.add('active');
  if(id==='settings')updateDbStatusBox();
  if(id==='warehouse'){renderWarehouse();renderWarehouseAuditLog();populateAuditProductDropdown();}
  if(id==='history'){renderHistory();renderBatchHistTable();renderShipHistTable();}
  if(id==='batch')renderBatchHistory();
  if(id==='ship')renderShipHistory();
}
// ============================================================
// TRANSLATIONS
// ============================================================
const T = {
  en: {
    // App
    appSubtitle:'Inventory System v4',
    // PIN
    pinHint:'Enter your 4-digit PIN<br>Default: 1234 ‚Äî change in Settings',
    pinIncorrect:'Incorrect PIN. Try again.',
    pinUpdated:'‚úì PIN updated',
    pinNewPrompt:'Enter your NEW 4-digit PIN',
    pinConfirmPrompt:'Confirm your new PIN',
    pinNoMatch:'PINs do not match.',
    // Tabs
    tabDash:'Dashboard', tabLog:'Log Run', tabBatch:'Batching', tabShip:'Ship',
    tabWarehouse:'Warehouse', tabReceive:'Receive', tabHistory:'History',
    tabExport:'Export', tabSettings:'Settings', tabAudit:'Audit',
    // Shared labels
    labelDate:'Date', labelShift:'Shift', labelOperator:'Operator',
    labelNotes:'Notes', labelSupplier:'Supplier', labelPO:'PO / Reference #',
    labelBags:'Bags', labelLot:'Lot #', labelCases:'Cases', labelLbs:'lbs',
    labelQty:'Quantity', labelQtyLbs:'Quantity (lbs)',
    shiftMorning:'Morning', shiftAfternoon:'Afternoon', shiftNight:'Night',
    // Filter buttons
    filterAll:'All', filterToday:'Today', filterWeek:'This Week', filterMonth:'This Month',
    allProducts:'All Products', inStockOnly:'In Stock Only',
    // Dashboard
    dashFGTitle:'Finished Goods ‚Äî Cases by Product (This Week)',
    dashRecentRuns:'Recent Runs',
    statCasesWeek:'Cases This Week', statRunsWeek:'Runs This Week',
    statFlourUsed:'Flour Used (lbs)', statAvgRatio:'Avg lbs/Case',
    noProdWeek:'No production this week',
    noRunsYet:'No runs logged yet',
    // Log Run
    logRunTitle:'Log Production Run',
    itemsProducedLabel:'Items Produced This Run',
    addItem:'+ Add Item',
    groupSelectorLabel:'Ingredient Group for This Run',
    selectGroup:'‚Äî Select Group ‚Äî',
    ingredientsUsed:'Ingredients Used',
    runSummary:'Run Summary',
    totalCases:'Total Cases', totalFlour:'Total Flour', flourPerCase:'Flour / Case',
    saveRun:'Save Run', clearBtn:'Clear',
    runSaved:'‚úì Run saved to cloud!',
    runErrDate:'‚ö† Enter a date',
    runErrGroup:'‚ö† Select an ingredient group',
    runErrFlour:'‚ö† Enter flour quantity for at least one silo',
    itemLabel:'Item',
    siloEntryLabel:'Silo Entry',
    addAnotherSilo:'+ Add Another Silo',
    selectSilo:'Select',
    selectProductFirst:'‚Äî Select product first ‚Äî',
    noStockProduct:'‚Äî No stock for this product ‚Äî',
    loadingBatches:'‚Äî Loading batches‚Ä¶ ‚Äî',
    noBatchesAvail:'‚Äî No batches available ‚Äî',
    selectBatch:'‚Äî Select Batch ‚Äî',
    casesRemaining:'cases remaining',
    groupADesc:'Burrito #2, #3, #3.5, #4, #6 ‚Äî uses Formula Batch (chemical pre-mix)',
    groupBDesc:'Burrito #1, #8, Harina, Authentico, Baby, Tonys, Mi Barrio ‚Äî uses Gordita, Sodium P., Fumaric Acid',
    groupCDesc:'Trigo #8, Baja ‚Äî uses Gordita, Fumaric Acid, Wheat Flour',
    // Ingredient names
    ingFlour:'üåæ Flour', ingWWFlour:'üåæ Wheat Flour',
    ingWater:'üíß Water', ingOil:'ü´ô Oil (50 lb case)',
    ingBeta:'üíä Beta Tablets', ingFormulaBatch:'üß™ Formula Batch',
    ingGordita:'üõçÔ∏è Gordita Bags', ingSodiumP:'üßÇ Sodium Propionate',
    ingFumaric:'‚öóÔ∏è Fumaric Acid',
    unitCasesLot:'Cases + Lot', unitTabletsLot:'Tablets + Lot',
    unitBagsLot:'Bags + Lot', unitLbsLot:'lbs + Lot',
    unitFromBatching:'From Batching Inventory',
    labelCasesUsed:'Cases Used', labelBatchDate:'Batch Date',
    labelTabletCount:'Tablet Count', labelBagQty:'Bag Qty',
    labelQtyTablets:'Quantity (tablets)', labelQtyCases:'Cases Used',
    // Batching
    batchTitle:'Formula Batching',
    batchDesc:'Pre-mix ingredients for later use in production runs. Each batch is logged here and becomes available in Log Run (Group A).',
    subBatch1:'Sub-Batch 1 ‚Äî Chemical Batch',
    subBatch2:'Sub-Batch 2 ‚Äî FGE Blend',
    batchDateLabel:'Date of Batching',
    totalCasesCreated:'Total Cases Created',
    numBagsMade:'Number of Bags Made',
    b1CalciumP:'Calcium Propionate', b1SodiumP:'Sodium Propionate',
    b1BakingP:'Baking Powder', b1Salt:'Salt',
    b2Fumaric:'Fumaric Acid', b2Guar:'Guar Gum', b2Enzyme:'Enzyme Blend',
    bagsUsed:'Bags Used',
    saveChemBatch:'üíæ Save Chemical Batch',
    saveFGEBatch:'üíæ Save FGE Blend Batch',
    batchSaved1:'‚úì Chemical batch saved!',
    batchSaved2:'‚úì FGE batch saved!',
    batchErrDate:'‚ö† Date and cases required',
    batchErrDate2:'‚ö† Date and bags made required',
    recentBatches:'Recent Batches',
    noBatches:'No batches yet',
    chemBatchLabel:'üß™ Chemical Batch',
    fgeBatchLabel:'üåø FGE Blend',
    casesCreated:'cases created', casesRemainingLabel:'remaining',
    bagsMadeLabel:'bags made',
    // Shipping
    shipTitle:'Log Shipment',
    shipRecipient:'Recipient / Destination',
    shipPO:'Reference / PO #',
    itemsShipped:'Items Shipped',
    addShipItem:'+ Add Item to Shipment',
    saveShipment:'üöö Save Shipment',
    shipHistory:'Shipment History',
    shipSaved:'‚úì Shipment saved!',
    shipDeleted:'‚úì Shipment deleted',
    shipErrDate:'‚ö† Date and recipient required',
    shipErrItems:'‚ö† Add at least one item',
    shipItemLabel:'Shipment Item',
    shipProductLabel:'Product', shipProdDateLabel:'Production Date',
    shipCasesLabel:'Cases to Ship',
    noShipments:'No shipments',
    // Warehouse
    warehouseTitle:'Warehouse ‚Äî Available Stock',
    warehouseDesc:'Formula: Cases Produced on Date X ‚àí Total Shipped from Date X = Available Stock. Grouped by product then production date (FIFO order).',
    noStockYet:'No stock data yet',
    noStockSub:'Log production runs and shipments to see FIFO stock levels',
    allShipped:'All stock shipped',
    casesTotalLabel:'cases total',
    // Receive
    receiveTitle:'Receive Inventory',
    itemsReceived:'Items Received',
    saveReceipt:'Save Receipt',
    receiptSaved:'‚úì Receipt saved to cloud!',
    recvErrDate:'‚ö† Enter a date',
    otherItemsReceived:'Other Items Received',
    otherItemsPlaceholder:'Item, qty, lot#‚Ä¶',
    ingWWFlourLabel:'Whole Wheat Flour',
    ingOilLabel:'Oil (50 lb case)',
    ingBetaLabel:'Beta Tablets',
    ingGorditaLabel:'Gordita Bags',
    ingSaltLabel:'Salt',
    ingBakingPLabel:'Baking Powder',
    ingCalciumLabel:'Calcium Propionate',
    ingSodiumPLabel:'Sodium Propionate',
    ingFumaricLabel:'Fumaric Acid',
    ingEnzymeLabel:'Enzyme Blend',
    ingGuarLabel:'Guar Gum',
    // History
    prodHistory:'Production History',
    receiptHistory:'Receipt History',
    noRuns:'No runs', noReceipts:'No receipts',
    colDate:'Date', colShift:'Shift', colOperator:'Operator', colGroup:'Group',
    colItems:'Items', colCases:'Cases', colFlourLbs:'Flour (lbs)',
    colLbsCase:'lbs/case', colPO:'PO #', colFlourLot:'Flour Lot',
    // Export
    exportTitle:'Export Data',
    exportDesc:'Download as Excel (.xlsx). Use date range filters or quick period buttons.',
    dateRangeFilter:'üìÖ Date Range Filter',
    startDate:'Start Date', endDate:'End Date',
    exportRange:'Export Range',
    exportRuns:'Production Runs',
    exportRunsDesc:'All ingredients, lot numbers, items produced, flour-per-case ratios.',
    exportShipments:'Shipments',
    exportShipmentsDesc:'All outbound shipments with products, quantities, and destinations.',
    exportReceipts:'Receipts',
    exportReceiptsDesc:'All incoming deliveries with supplier, lot numbers, and quantities.',
    exportBatches:'Formula Batches',
    exportBatchesDesc:'Chemical batches and FGE blend batches.',
    exportWarehouseLabel:'Warehouse Stock',
    exportWarehouseDesc:'Current available stock by product and production date.',
    exportFullLabel:'Full Report',
    exportFullDesc:'All modules in one Excel file with separate sheets.',
    exportCurrentStock:'Current Stock',
    exportErrNoData:'‚ö† No data',
    exportErrNoShipments:'‚ö† No shipments',
    exportErrNoReceipts:'‚ö† No receipts',
    exportErrNoBatches:'‚ö† No batches',
    exportErrNoStock:'‚ö† No stock data',
    exportErrNoRange:'‚ö† Set at least one date',
    exportErrNoRange2:'‚ö† No data in range',
    // Settings
    settingsTitle:'Settings',
    changePIN:'Change PIN',
    changePINSub:'Update your 4-digit security PIN',
    changeBtn:'Change',
    clearAllData:'Clear All Local Data',
    clearAllDataSub:'Does not delete Supabase data',
    clearBtn2:'Clear',
    clearConfirm:'Clear all local data?',
    userRoles:'User Access & Roles',
    phase2Title:'Phase 2 ‚Äî Coming Soon',
    phase2Sub:'Individual user PINs with role-based access:<br>Log Run User ¬∑ Batching User ¬∑ Admin',
    dbStatus:'Database Status',
    dbConnected:'Connected to Supabase',
    dbNotConnected:'Not connected',
    versionLabel:'Version',
    // Audit
    auditTitle:'Audit Log',
    auditPinSub:'Enter the audit PIN to continue',
    auditPinErr:'Incorrect PIN.',
    auditExport:'üì• Export',
    auditLock:'üîí Lock',
    auditNoRecords:'No audit records',
    // Edit modals
    editRunTitle:'‚úèÔ∏è Edit Production Run',
    editRecTitle:'‚úèÔ∏è Edit Receipt',
    changedByLabel:'‚òÖ Changed By (required)',
    changedByPlaceholder:'Your name',
    saveChanges:'üíæ Save Changes',
    deleteBtn:'üóë Delete',
    editRunSaved:'‚úì Run updated!',
    editRecSaved:'‚úì Receipt updated!',
    runDeleted:'‚úì Run deleted',
    receiptDeleted:'‚úì Receipt deleted',
    editErrDate:'‚ö† Date required',
    editErrName:'‚ö† Enter your name in Changed By',
    editErrNameDel:'‚ö† Enter your name in Changed By before deleting',
    deleteRunConfirm:'Delete run',
    deleteRecConfirm:'Delete receipt',
    cannotUndo:'This cannot be undone.',
    auditNamePrompt:'Your name (for audit log):',
    // DB / Sync
    syncConnecting:'‚è≥ Connecting',
    syncOk:'‚òÅ Synced',
    syncOffline:'‚ö† Offline',
    loadingDB:'Connecting to database‚Ä¶',
    // Warehouse export column headers
    whColProduct:'Product', whColDate:'Production Date', whColAvail:'Available Cases',
    b150lbBags:'50lb Bags', label50lbBags:'50lb Bags', labelTablets:'Tablets', fgeRatio:'1 set of these ingredients = 1 FGE Blend bag.',
    deleteShipConfirm:'Delete this shipment? Stock will be restored.',
  },
  es: {
    // App
    appSubtitle:'Sistema de Inventario v4',
    // PIN
    pinHint:'Ingrese su PIN de 4 d√≠gitos<br>Predeterminado: 1234 ‚Äî cambiar en Configuraci√≥n',
    pinIncorrect:'PIN incorrecto. Intente de nuevo.',
    pinUpdated:'‚úì PIN actualizado',
    pinNewPrompt:'Ingrese su NUEVO PIN de 4 d√≠gitos',
    pinConfirmPrompt:'Confirme su nuevo PIN',
    pinNoMatch:'Los PINs no coinciden.',
    // Tabs
    tabDash:'Panel', tabLog:'Registrar', tabBatch:'Mezclas', tabShip:'Env√≠o',
    tabWarehouse:'Almac√©n', tabReceive:'Recibir', tabHistory:'Historial',
    tabExport:'Exportar', tabSettings:'Ajustes', tabAudit:'Auditor√≠a',
    // Shared labels
    labelDate:'Fecha', labelShift:'Turno', labelOperator:'Operador',
    labelNotes:'Notas', labelSupplier:'Proveedor', labelPO:'# de Orden / Referencia',
    labelBags:'Bolsas', labelLot:'# de Lote', labelCases:'Cajas', labelLbs:'lbs',
    labelQty:'Cantidad', labelQtyLbs:'Cantidad (lbs)',
    shiftMorning:'Ma√±ana', shiftAfternoon:'Tarde', shiftNight:'Noche',
    // Filter buttons
    filterAll:'Todo', filterToday:'Hoy', filterWeek:'Esta Semana', filterMonth:'Este Mes',
    allProducts:'Todos los Productos', inStockOnly:'Solo en Stock',
    // Dashboard
    dashFGTitle:'Producto Terminado ‚Äî Cajas por Producto (Esta Semana)',
    dashRecentRuns:'Corridas Recientes',
    statCasesWeek:'Cajas Esta Semana', statRunsWeek:'Corridas Esta Semana',
    statFlourUsed:'Harina Usada (lbs)', statAvgRatio:'Prom. lbs/Caja',
    noProdWeek:'Sin producci√≥n esta semana',
    noRunsYet:'Sin corridas registradas',
    // Log Run
    logRunTitle:'Registrar Corrida de Producci√≥n',
    itemsProducedLabel:'Art√≠culos Producidos Esta Corrida',
    addItem:'+ Agregar Art√≠culo',
    groupSelectorLabel:'Grupo de Ingredientes para Esta Corrida',
    selectGroup:'‚Äî Seleccionar Grupo ‚Äî',
    ingredientsUsed:'Ingredientes Utilizados',
    runSummary:'Resumen de Corrida',
    totalCases:'Total Cajas', totalFlour:'Total Harina', flourPerCase:'Harina / Caja',
    saveRun:'Guardar Corrida', clearBtn:'Limpiar',
    runSaved:'‚úì ¬°Corrida guardada en la nube!',
    runErrDate:'‚ö† Ingrese una fecha',
    runErrGroup:'‚ö† Seleccione un grupo de ingredientes',
    runErrFlour:'‚ö† Ingrese la cantidad de harina para al menos un silo',
    itemLabel:'Art√≠culo',
    siloEntryLabel:'Entrada de Silo',
    addAnotherSilo:'+ Agregar Otro Silo',
    selectSilo:'Seleccionar',
    selectProductFirst:'‚Äî Seleccione un producto primero ‚Äî',
    noStockProduct:'‚Äî Sin stock para este producto ‚Äî',
    loadingBatches:'‚Äî Cargando lotes‚Ä¶ ‚Äî',
    noBatchesAvail:'‚Äî Sin lotes disponibles ‚Äî',
    selectBatch:'‚Äî Seleccionar Lote ‚Äî',
    casesRemaining:'cajas disponibles',
    groupADesc:'Burrito #2, #3, #3.5, #4, #6 ‚Äî usa Lote de F√≥rmula (premezcla qu√≠mica)',
    groupBDesc:'Burrito #1, #8, Harina, Aut√©ntico, Baby, Tonys, Mi Barrio ‚Äî usa Gordita, Prop. Sodio, √Åc. Fum√°rico',
    groupCDesc:'Trigo #8, Baja ‚Äî usa Gordita, √Åc. Fum√°rico, Harina de Trigo',
    // Ingredient names
    ingFlour:'üåæ Harina', ingWWFlour:'üåæ Harina de Trigo Integral',
    ingWater:'üíß Agua', ingOil:'ü´ô Aceite (caja 50 lbs)',
    ingBeta:'üíä Tabletas Beta', ingFormulaBatch:'üß™ Lote de F√≥rmula',
    ingGordita:'üõçÔ∏è Bolsas Gordita', ingSodiumP:'üßÇ Propionato de Sodio',
    ingFumaric:'‚öóÔ∏è √Åcido Fum√°rico',
    unitCasesLot:'Cajas + Lote', unitTabletsLot:'Tabletas + Lote',
    unitBagsLot:'Bolsas + Lote', unitLbsLot:'lbs + Lote',
    unitFromBatching:'Del Inventario de Mezclas',
    labelCasesUsed:'Cajas Usadas', labelBatchDate:'Fecha del Lote',
    labelTabletCount:'Cantidad de Tabletas', labelBagQty:'Cantidad de Bolsas',
    labelQtyTablets:'Cantidad (tabletas)', labelQtyCases:'Cajas Usadas',
    // Batching
    batchTitle:'Mezcla de F√≥rmulas',
    batchDesc:'Premezcle ingredientes para su uso posterior en corridas de producci√≥n. Cada lote se registra aqu√≠ y queda disponible en Registrar Corrida (Grupo A).',
    subBatch1:'Sub-Lote 1 ‚Äî Lote Qu√≠mico',
    subBatch2:'Sub-Lote 2 ‚Äî Mezcla FGE',
    batchDateLabel:'Fecha de Mezcla',
    totalCasesCreated:'Total Cajas Creadas',
    numBagsMade:'N√∫mero de Bolsas Elaboradas',
    b1CalciumP:'Propionato de Calcio', b1SodiumP:'Propionato de Sodio',
    b1BakingP:'Polvo para Hornear', b1Salt:'Sal',
    b2Fumaric:'√Åcido Fum√°rico', b2Guar:'Goma Guar', b2Enzyme:'Mezcla de Enzimas',
    bagsUsed:'Bolsas Usadas',
    saveChemBatch:'üíæ Guardar Lote Qu√≠mico',
    saveFGEBatch:'üíæ Guardar Lote Mezcla FGE',
    batchSaved1:'‚úì ¬°Lote qu√≠mico guardado!',
    batchSaved2:'‚úì ¬°Lote FGE guardado!',
    batchErrDate:'‚ö† Se requiere fecha y cajas',
    batchErrDate2:'‚ö† Se requiere fecha y bolsas elaboradas',
    recentBatches:'Lotes Recientes',
    noBatches:'Sin lotes registrados',
    chemBatchLabel:'üß™ Lote Qu√≠mico',
    fgeBatchLabel:'üåø Mezcla FGE',
    casesCreated:'cajas creadas', casesRemainingLabel:'disponibles',
    bagsMadeLabel:'bolsas elaboradas',
    // Shipping
    shipTitle:'Registrar Env√≠o',
    shipRecipient:'Destinatario / Destino',
    shipPO:'Referencia / # de Orden',
    itemsShipped:'Art√≠culos Enviados',
    addShipItem:'+ Agregar Art√≠culo al Env√≠o',
    saveShipment:'üöö Guardar Env√≠o',
    shipHistory:'Historial de Env√≠os',
    shipSaved:'‚úì ¬°Env√≠o guardado!',
    shipDeleted:'‚úì Env√≠o eliminado',
    shipErrDate:'‚ö† Se requiere fecha y destinatario',
    shipErrItems:'‚ö† Agregue al menos un art√≠culo',
    shipItemLabel:'Art√≠culo del Env√≠o',
    shipProductLabel:'Producto', shipProdDateLabel:'Fecha de Producci√≥n',
    shipCasesLabel:'Cajas a Enviar',
    noShipments:'Sin env√≠os',
    // Warehouse
    warehouseTitle:'Almac√©n ‚Äî Stock Disponible',
    warehouseDesc:'F√≥rmula: Cajas Producidas en Fecha X ‚àí Total Enviado de Fecha X = Stock Disponible. Agrupado por producto y fecha de producci√≥n (orden FIFO).',
    noStockYet:'Sin datos de stock',
    noStockSub:'Registre corridas de producci√≥n y env√≠os para ver los niveles de stock FIFO',
    allShipped:'Todo el stock enviado',
    casesTotalLabel:'cajas en total',
    // Receive
    receiveTitle:'Recibir Inventario',
    itemsReceived:'Art√≠culos Recibidos',
    saveReceipt:'Guardar Recibo',
    receiptSaved:'‚úì ¬°Recibo guardado en la nube!',
    recvErrDate:'‚ö† Ingrese una fecha',
    otherItemsReceived:'Otros Art√≠culos Recibidos',
    otherItemsPlaceholder:'Art√≠culo, cantidad, lote#‚Ä¶',
    ingWWFlourLabel:'Harina de Trigo Integral',
    ingOilLabel:'Aceite (caja 50 lbs)',
    ingBetaLabel:'Tabletas Beta',
    ingGorditaLabel:'Bolsas Gordita',
    ingSaltLabel:'Sal',
    ingBakingPLabel:'Polvo para Hornear',
    ingCalciumLabel:'Propionato de Calcio',
    ingSodiumPLabel:'Propionato de Sodio',
    ingFumaricLabel:'√Åcido Fum√°rico',
    ingEnzymeLabel:'Mezcla de Enzimas',
    ingGuarLabel:'Goma Guar',
    // History
    prodHistory:'Historial de Producci√≥n',
    receiptHistory:'Historial de Recibos',
    noRuns:'Sin corridas', noReceipts:'Sin recibos',
    colDate:'Fecha', colShift:'Turno', colOperator:'Operador', colGroup:'Grupo',
    colItems:'Art√≠culos', colCases:'Cajas', colFlourLbs:'Harina (lbs)',
    colLbsCase:'lbs/caja', colPO:'# Orden', colFlourLot:'Lote Harina',
    // Export
    exportTitle:'Exportar Datos',
    exportDesc:'Descarga en formato Excel (.xlsx). Use filtros de rango de fechas o botones r√°pidos.',
    dateRangeFilter:'üìÖ Filtro de Rango de Fechas',
    startDate:'Fecha Inicio', endDate:'Fecha Fin',
    exportRange:'Exportar Rango',
    exportRuns:'Corridas de Producci√≥n',
    exportRunsDesc:'Ingredientes, lotes, art√≠culos producidos y ratios harina-caja.',
    exportShipments:'Env√≠os',
    exportShipmentsDesc:'Todos los env√≠os con productos, cantidades y destinos.',
    exportReceipts:'Recibos',
    exportReceiptsDesc:'Todas las entregas con proveedor, lotes y cantidades.',
    exportBatches:'Lotes de F√≥rmula',
    exportBatchesDesc:'Lotes qu√≠micos y lotes de mezcla FGE.',
    exportWarehouseLabel:'Stock del Almac√©n',
    exportWarehouseDesc:'Stock disponible actual por producto y fecha de producci√≥n.',
    exportFullLabel:'Reporte Completo',
    exportFullDesc:'Todos los m√≥dulos en un archivo Excel con hojas separadas.',
    exportCurrentStock:'Stock Actual',
    exportErrNoData:'‚ö† Sin datos',
    exportErrNoShipments:'‚ö† Sin env√≠os',
    exportErrNoReceipts:'‚ö† Sin recibos',
    exportErrNoBatches:'‚ö† Sin lotes',
    exportErrNoStock:'‚ö† Sin datos de stock',
    exportErrNoRange:'‚ö† Establezca al menos una fecha',
    exportErrNoRange2:'‚ö† Sin datos en el rango',
    // Settings
    settingsTitle:'Configuraci√≥n',
    changePIN:'Cambiar PIN',
    changePINSub:'Actualizar PIN de seguridad de 4 d√≠gitos',
    changeBtn:'Cambiar',
    clearAllData:'Borrar Datos Locales',
    clearAllDataSub:'No borra datos de Supabase',
    clearBtn2:'Borrar',
    clearConfirm:'¬øBorrar todos los datos locales?',
    userRoles:'Acceso y Roles de Usuarios',
    phase2Title:'Fase 2 ‚Äî Pr√≥ximamente',
    phase2Sub:'PINs individuales con acceso basado en roles:<br>Registrador ¬∑ Mezclador ¬∑ Administrador',
    dbStatus:'Estado de Base de Datos',
    dbConnected:'Conectado a Supabase',
    dbNotConnected:'Sin conexi√≥n',
    versionLabel:'Versi√≥n',
    // Audit
    auditTitle:'Registro de Auditor√≠a',
    auditPinSub:'Ingrese el PIN de auditor√≠a para continuar',
    auditPinErr:'PIN incorrecto.',
    auditExport:'üì• Exportar',
    auditLock:'üîí Bloquear',
    auditNoRecords:'Sin registros de auditor√≠a',
    // Edit modals
    editRunTitle:'‚úèÔ∏è Editar Corrida de Producci√≥n',
    editRecTitle:'‚úèÔ∏è Editar Recibo',
    changedByLabel:'‚òÖ Modificado Por (requerido)',
    changedByPlaceholder:'Su nombre',
    saveChanges:'üíæ Guardar Cambios',
    deleteBtn:'üóë Eliminar',
    editRunSaved:'‚úì ¬°Corrida actualizada!',
    editRecSaved:'‚úì ¬°Recibo actualizado!',
    runDeleted:'‚úì Corrida eliminada',
    receiptDeleted:'‚úì Recibo eliminado',
    editErrDate:'‚ö† Fecha requerida',
    editErrName:'‚ö† Ingrese su nombre en Modificado Por',
    editErrNameDel:'‚ö† Ingrese su nombre en Modificado Por antes de eliminar',
    deleteRunConfirm:'Eliminar corrida',
    deleteRecConfirm:'Eliminar recibo',
    cannotUndo:'Esta acci√≥n no se puede deshacer.',
    auditNamePrompt:'Su nombre (para registro de auditor√≠a):',
    // DB / Sync
    syncConnecting:'‚è≥ Conectando',
    syncOk:'‚òÅ Sincronizado',
    syncOffline:'‚ö† Sin conexi√≥n',
    loadingDB:'Conectando a la base de datos‚Ä¶',
    // Warehouse export headers
    whColProduct:'Producto', whColDate:'Fecha de Producci√≥n', whColAvail:'Cajas Disponibles',
    b150lbBags:'Bolsas 50 lbs', label50lbBags:'Bolsas 50 lbs', labelTablets:'Tabletas', fgeRatio:'1 conjunto de ingredientes = 1 bolsa de Mezcla FGE',
    deleteShipConfirm:'¬øEliminar este env√≠o? Se restaurar√° el stock.',
  }
};

function t(k){ return T[currentLang][k] || T['en'][k] || k; }

function setLang(lang){
  currentLang = lang;
  g('btn-en').classList.toggle('active', lang==='en');
  g('btn-es').classList.toggle('active', lang==='es');
  applyTranslations();
  // Re-render dynamic content with new language
  refreshDashboard();
  renderHistory();
  renderShipHistory();
  renderBatchHistory();
  if(document.getElementById('panel-warehouse').classList.contains('active')) renderWarehouse();
}

function applyTranslations(){
  // data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n');
    const val = t(k);
    // Use innerHTML for entries that may contain <br>
    if(val.includes('<br>') || val.includes('<span')) el.innerHTML = val;
    else el.textContent = val;
  });
  // select option translations
  document.querySelectorAll('[data-i18n-opt]').forEach(el=>{
    const k = el.getAttribute('data-i18n-opt');
    el.textContent = t(k);
  });
  // Placeholders
  const phMap = {
    'run-operator': '‚Äî', 'run-notes': '‚Äî',
    'ship-recipient': '‚Äî', 'ship-po': '‚Äî', 'ship-notes': '‚Äî',
    'recv-supplier': '‚Äî', 'recv-po': '‚Äî',
    'recv-other': () => t('otherItemsPlaceholder'),
    'batch1-notes': '‚Äî', 'batch2-notes': '‚Äî',
    'edit-run-operator': '‚Äî', 'edit-recv-supplier': '‚Äî',
    'edit-run-changed-by': () => t('changedByPlaceholder'),
    'edit-recv-changed-by': () => t('changedByPlaceholder'),
  };
  Object.entries(phMap).forEach(([id, val])=>{
    const el = g(id);
    if(el) el.placeholder = typeof val === 'function' ? val() : val;
  });
  // Update pin hint
  const hint = g('pin-hint');
  if(hint) hint.innerHTML = t('pinHint');
  // Update sync indicator if currently showing a translated string
  updateSyncText();
  // Update DB status box if visible
  const panel = g('panel-settings');
  if(panel && panel.classList.contains('active')) updateDbStatusBox();
}

function updateSyncText(){
  const el = g('sync-indicator');
  if(!el) return;
  const cls = el.className;
  if(cls.includes('ok')) el.textContent = t('syncOk');
  else if(cls.includes('err')) el.textContent = t('syncOffline');
  else el.textContent = t('syncConnecting');
}
function clearLocalData(){if(!confirm(t('clearConfirm')))return;localStorage.clear();location.reload();}
function versionTap(){_vtaps++;clearTimeout(_vtimer);_vtimer=setTimeout(()=>{_vtaps=0;},2000);if(_vtaps>=7){_vtaps=0;revealAuditTab();}}

// ============================================================
// INGREDIENT GROUP LOGIC
// ============================================================
function updateIngredientGroup(){
  const group=gt('run-group');
  const container=g('ing-fields');
  const desc=g('group-desc');
  if(!group){container.innerHTML='<div class="empty-state" style="padding:20px;"><div class="empty-icon" style="font-size:28px;">‚òùÔ∏è</div><div class="empty-text" style="font-size:14px;">Select a product group above</div></div>';desc.textContent='';return;}

  let html='';
  // All groups have Flour (multi-silo), Water, Oil + Beta
  if(group==='C'){
    html+=`
    <div class="ing-row">
      <div class="ing-row-header"><span class="ing-name">${t('ingWWFlour')}</span><span class="ing-unit-badge group-badge C">50 lbs Bags</span></div>
      <div class="form-row-3">
        <div class="form-group"><label>${t('labelNumBags')||'# of 50 lb Bags'}</label><input type="number" inputmode="numeric" id="ww-bags" placeholder="0" oninput="updateSummary()"></div>
        <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="ww-lot" placeholder="LOT-XXXX"></div>
        <div class="form-group"><label>${t('labelQtyLbs')}</label><input type="number" inputmode="decimal" id="ww-lbs" placeholder="0" oninput="updateSummary()"></div>
      </div>
    </div>`;
  } else {
    html+=`
    <div class="ing-row">
      <div class="ing-row-header"><span class="ing-name">${t('ingFlour')}</span><span class="ing-unit-badge group-badge ${group}">Silo</span></div>
      <div id="silo-entries"></div>
      <button class="btn-add-silo" onclick="addSiloEntry()">${t('addAnotherSilo')}</button>
    </div>`;
  }
  html+=`
  <div class="ing-row">
    <div class="ing-row-header"><span class="ing-name">${t('ingWater')}</span><span class="ing-unit-badge">${t('labelLbs')}</span></div>
    <div class="form-group"><label>${t('labelQtyLbs')}</label><input type="number" inputmode="decimal" id="ing-water" placeholder="0"></div>
  </div>
  <div class="ing-row">
    <div class="ing-row-header"><span class="ing-name">${t('ingOil')}</span><span class="ing-unit-badge">${t('unitCasesLot')}</span></div>
    <div class="form-row-2">
      <div class="form-group"><label>${t('labelCasesUsed')}</label><input type="number" inputmode="decimal" id="ing-oil" placeholder="0"></div>
      <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="lot-oil" placeholder="LOT-XXXX"></div>
    </div>
  </div>
  <div class="ing-row">
    <div class="ing-row-header"><span class="ing-name">${t('ingBeta')}</span><span class="ing-unit-badge">${t('unitTabletsLot')}</span></div>
    <div class="form-row-2">
      <div class="form-group"><label>${t('labelTabletCount')}</label><input type="number" inputmode="numeric" id="ing-beta" placeholder="0"></div>
      <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="lot-beta" placeholder="LOT-XXXX"></div>
    </div>
  </div>`;

  if(group==='A'){
    desc.innerHTML=`<span class="group-badge A">Group A</span> ${t('groupADesc')}`;
    html+=`
    <div class="ing-row" id="batch-repeater-container">
      <div class="ing-row-header"><span class="ing-name">${t('ingFormulaBatch')}</span><span class="ing-unit-badge" style="background:#1a3a2a;color:var(--green);border-color:var(--green);">${t('unitFromBatching')}</span></div>
      <div id="batch-entries"></div>
      <button class="btn-add-silo" onclick="addBatchEntry()" style="margin-top:6px;">+ ${t('addAnotherBatch')||'Add Another Batch'}</button>
    </div>`;
  }

  if(group==='B'){
    desc.innerHTML=`<span class="group-badge B">Group B</span> ${t('groupBDesc')}`;
    html+=`
    <div class="ing-row">
      <div class="ing-row-header"><span class="ing-name">${t('ingGordita')}</span><span class="ing-unit-badge">${t('unitBagsLot')}</span></div>
      <div class="form-row-2">
        <div class="form-group"><label>${t('labelBagQty')}</label><input type="number" inputmode="numeric" id="ing-gordita" placeholder="0"></div>
        <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="lot-gordita" placeholder="LOT-XXXX"></div>
      </div>
    </div>
    <div class="ing-row">
      <div class="ing-row-header"><span class="ing-name">${t('ingSodiumP')}</span><span class="ing-unit-badge">${t('unitLbsLot')}</span></div>
      <div class="form-row-2">
        <div class="form-group"><label>${t('labelQtyLbs')}</label><input type="number" inputmode="decimal" id="ing-sodiump" placeholder="0"></div>
        <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="lot-sodiump" placeholder="LOT-XXXX"></div>
      </div>
    </div>
    <div class="ing-row">
      <div class="ing-row-header"><span class="ing-name">${t('ingFumaric')}</span><span class="ing-unit-badge">${t('unitLbsLot')}</span></div>
      <div class="form-row-2">
        <div class="form-group"><label>${t('labelQtyLbs')}</label><input type="number" inputmode="decimal" id="ing-fumaric" placeholder="0"></div>
        <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="lot-fumaric" placeholder="LOT-XXXX"></div>
      </div>
    </div>`;
  }

  if(group==='C'){
    desc.innerHTML=`<span class="group-badge C">Group C</span> ${t('groupCDesc')}`;
    html+=`
    <div class="ing-row">
      <div class="ing-row-header"><span class="ing-name">${t('ingGordita')}</span><span class="ing-unit-badge">${t('unitBagsLot')}</span></div>
      <div class="form-row-2">
        <div class="form-group"><label>${t('labelBagQty')}</label><input type="number" inputmode="numeric" id="ing-gordita" placeholder="0"></div>
        <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="lot-gordita" placeholder="LOT-XXXX"></div>
      </div>
    </div>
    <div class="ing-row">
      <div class="ing-row-header"><span class="ing-name">${t('ingFumaric')}</span><span class="ing-unit-badge">${t('unitLbsLot')}</span></div>
      <div class="form-row-2">
        <div class="form-group"><label>${t('labelQtyLbs')}</label><input type="number" inputmode="decimal" id="ing-fumaric" placeholder="0"></div>
        <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="lot-fumaric" placeholder="LOT-XXXX"></div>
      </div>
    </div>`;
  }

  container.innerHTML=html;
  siloCount=0;
  if(group!=='C') addSiloEntry(); // start with one silo entry (Group C uses bags instead)

  if(group==='A') loadBatchDropdown();
}

// ============================================================
// SILO MULTI-ENTRY
// ============================================================
function addSiloEntry(){
  siloCount++;
  const div=document.createElement('div');
  div.className='silo-entry';
  div.id='silo-entry-'+siloCount;
  div.innerHTML=`
    <div class="silo-entry-header">
      ${t('siloEntryLabel')} ${siloCount}
      ${siloCount>1?`<button onclick="g('silo-entry-${siloCount}').remove()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:16px;">‚úï</button>`:''}
    </div>
    <div class="form-row-3">
      <div class="form-group"><label>Silo #</label>
        <select id="silo-${siloCount}">
          <option value="">${t('selectSilo')}</option>
          <option value="Silo 1">Silo 1</option>
          <option value="Silo 2">Silo 2</option>
          <option value="Silo 3">Silo 3</option>
        </select>
      </div>
      <div class="form-group"><label>${t('labelQtyLbs')}</label><input type="number" inputmode="decimal" id="silo-lbs-${siloCount}" placeholder="0" oninput="updateSummary()"></div>
      <div class="form-group"><label>${t('labelLot')}</label><input type="text" id="silo-lot-${siloCount}" placeholder="LOT-XXXX"></div>
    </div>`;
  g('silo-entries').appendChild(div);
}

function collectSilos(){
  const group=gt('run-group');
  // Group C uses bags input instead of silos
  if(group==='C'){
    const bags=gv('ww-bags');
    const lbs=gv('ww-lbs');
    const lot=gt('ww-lot');
    const totalFlour=lbs||(bags*50);
    const entries=bags>0||lbs>0?[{silo:'Bags',bags,lbs:totalFlour,lot}]:[];
    return{entries,totalFlour};
  }
  const entries=[];
  let totalFlour=0;
  document.querySelectorAll('.silo-entry[id^="silo-entry-"]').forEach(el=>{
    const id=el.id.replace('silo-entry-','');
    const silo=gt('silo-'+id);
    const lbs=gv('silo-lbs-'+id);
    const lot=gt('silo-lot-'+id);
    if(silo&&lbs>0){entries.push({silo,lbs,lot});totalFlour+=lbs;}
  });
  return{entries,totalFlour};
}

// ============================================================
// BATCH REPEATER (for Group A runs)
// ============================================================
let batchEntryCount=0;
function buildBatchOptions(){
  const available=batches.filter(b=>b.batch_type==='chemical'&&(b.remaining_cases||b.total_cases)>0);
  if(!available.length) return `<option value="">${t('noBatchesAvail')}</option>`;
  return `<option value="">${t('selectBatch')}</option>`+
    available.map(b=>`<option value="${b.id}">${b.date} ‚Äî ${b.remaining_cases||b.total_cases} ${t('casesRemaining')}</option>`).join('');
}
function addBatchEntry(){
  batchEntryCount++;
  const container=g('batch-entries');
  if(!container)return;
  const div=document.createElement('div');
  div.className='silo-entry';div.id='batch-entry-'+batchEntryCount;
  div.innerHTML=`
    <div class="silo-entry-header">
      ${t('ingFormulaBatch')||'Formula Batch'} ${batchEntryCount}
      ${batchEntryCount>1?`<button onclick="g('batch-entry-${batchEntryCount}').remove()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:16px;">‚úï</button>`:''}
    </div>
    <div class="form-row-2">
      <div class="form-group"><label>${t('selectBatch')||'Select Batch'}</label>
        <select id="batch-sel-${batchEntryCount}">${buildBatchOptions()}</select>
      </div>
      <div class="form-group"><label>${t('labelCasesUsed')}</label>
        <input type="number" inputmode="numeric" id="batch-cases-${batchEntryCount}" placeholder="0">
      </div>
    </div>`;
  container.appendChild(div);
}
function loadBatchDropdown(){
  // Initialize first batch entry when group A selected
  batchEntryCount=0;
  const container=g('batch-entries');
  if(container){container.innerHTML='';addBatchEntry();}
}
function collectBatches(){
  const entries=[];
  document.querySelectorAll('.silo-entry[id^="batch-entry-"]').forEach(el=>{
    const id=el.id.replace('batch-entry-','');
    const batchId=g('batch-sel-'+id)?.value||'';
    const cases=parseFloat(g('batch-cases-'+id)?.value)||0;
    if(batchId&&cases>0) entries.push({batch_id:batchId,cases});
  });
  return entries;
}

// ============================================================
// ITEMS PRODUCED
// ============================================================
function addItem(){
  itemCount++;
  const div=document.createElement('div');
  div.className='item-entry';div.id='item-'+itemCount;
  div.innerHTML=`<div class="item-entry-header"><div class="item-num">${t('itemLabel')} ${itemCount}</div><button class="remove-btn" onclick="removeItem(${itemCount})">‚úï</button></div>
    <div class="form-group"><label>${t('shipProductLabel')}</label><select class="item-select">${PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('')}</select></div>
    <div class="form-group"><label>${t('totalCases')}</label><input type="number" inputmode="numeric" class="item-cases" placeholder="0" oninput="updateSummary()"></div>`;
  g('items-container').appendChild(div);
  updateSummary();
}
function removeItem(id){const el=g('item-'+id);if(el)el.remove();updateSummary();}

function updateSummary(){
  const{totalFlour}=collectSilos();
  let total=0;
  document.querySelectorAll('.item-cases').forEach(inp=>{total+=parseFloat(inp.value)||0;});
  const ratio=total>0?(totalFlour/total).toFixed(2):'‚Äî';
  g('sum-cases').textContent=total>0?total:'‚Äî';
  g('sum-flour').textContent=totalFlour>0?totalFlour.toLocaleString()+' lbs':'‚Äî';
  g('sum-ratio').textContent=ratio!=='‚Äî'?ratio+' lbs/case':'‚Äî';
}

// ============================================================
// SAVE RUN
// ============================================================
async function saveRun(){
  const date=gt('run-date');
  const group=gt('run-group');
  if(!date){showToast(t('runErrDate'),true);return;}
  if(!group){showToast(t('runErrGroup'),true);return;}

  const{entries:siloEntries,totalFlour}=collectSilos();
  if(!siloEntries.length||totalFlour===0){showToast(t('runErrFlour'),true);return;}

  const items=[];let totalCases=0;
  document.querySelectorAll('#items-container .item-entry').forEach(entry=>{
    const name=entry.querySelector('.item-select')?.value||'';
    const cases=parseFloat(entry.querySelector('.item-cases')?.value)||0;
    if(name&&cases>0){items.push({name,cases});totalCases+=cases;}
  });

  const run={
    date,shift:gt('run-shift'),operator:gt('run-operator'),
    product_group:group,
    flour:totalFlour,
    silos_json:JSON.stringify(siloEntries),
    water:gv('ing-water'),
    oil:gv('ing-oil'),lot_oil:gt('lot-oil'),
    beta:gv('ing-beta'),lot_beta:gt('lot-beta'),
    // Group A ‚Äî multi-batch (serialized as JSON)
    batches_json:group==='A'?JSON.stringify(collectBatches()):'[]',
    // Group B & C
    gordita:['B','C'].includes(group)?gv('ing-gordita'):0,
    lot_gordita:['B','C'].includes(group)?gt('lot-gordita'):'',
    fumaric:['B','C'].includes(group)?gv('ing-fumaric'):0,
    lot_fumaric:['B','C'].includes(group)?gt('lot-fumaric'):'',
    // Group B only
    sodiump:group==='B'?gv('ing-sodiump'):0,
    lot_sodiump:group==='B'?gt('lot-sodiump'):'',
    items_json:JSON.stringify(items),
    total_cases:totalCases,
    ratio:totalCases>0?(totalFlour/totalCases).toFixed(2):'0',
    notes:gt('run-notes')
  };

  showLoading(t('savingRun')||'Saving‚Ä¶');
  try{
    const saved=await SB.insert('production_runs',run);
    runs.unshift({...run,id:saved[0]?.id||Date.now(),items,totalCases});
    clearRun();refreshDashboard();
    showToast(t('runSaved'));
    showTab('dash');
  }catch(err){
    showToast('‚ö† Error saving: '+err.message,true);
    setSyncIndicator('err',t('syncOffline'));
  }finally{hideLoading();}
}

function clearRun(){
  g('run-date').value=new Date().toISOString().split('T')[0];
  g('run-operator').value='';
  g('run-notes').value='';
  g('run-group').value='';
  g('items-container').innerHTML='';
  itemCount=0;
  g('ing-fields').innerHTML='<div class="empty-state" style="padding:20px;"><div class="empty-icon" style="font-size:28px;">‚òùÔ∏è</div><div class="empty-text" style="font-size:14px;">Select a product group above</div></div>';
  g('group-desc').textContent='';
  g('sum-cases').textContent='‚Äî';g('sum-flour').textContent='‚Äî';g('sum-ratio').textContent='‚Äî';
  addItem();
}

// ============================================================
// FORMULA BATCHING
// ============================================================
async function saveBatch1(){
  const date=gt('batch1-date');
  const cases=gv('batch1-cases');
  if(!date||cases===0){showToast(t('batchErrDate'),true);return;}
  const batch={
    date,batch_type:'chemical',total_cases:cases,remaining_cases:cases,
    calcium_bags:gv('b1-calcium-bags'),calcium_lot:gt('b1-calcium-lot'),
    sodium_bags:gv('b1-sodium-bags'),sodium_lot:gt('b1-sodium-lot'),
    baking_bags:gv('b1-baking-bags'),baking_lot:gt('b1-baking-lot'),
    salt_bags:gv('b1-salt-bags'),salt_lot:gt('b1-salt-lot'),
    notes:gt('batch1-notes')
  };
  showLoading(t('savingBatch')||'Saving‚Ä¶');
  try{
    const saved=await SB.insert('formula_batches',batch);
    batches.unshift({...batch,id:saved[0]?.id||Date.now()});
    ['batch1-date','batch1-cases','b1-calcium-bags','b1-calcium-lot','b1-sodium-bags','b1-sodium-lot','b1-baking-bags','b1-baking-lot','b1-salt-bags','b1-salt-lot','batch1-notes'].forEach(id=>{const el=g(id);if(el)el.value='';});
    g('batch1-date').value=new Date().toISOString().split('T')[0];
    renderBatchHistory();
    showToast(t('batchSaved1'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

async function saveBatch2(){
  const date=gt('batch2-date');
  const bagsMade=gv('batch2-bags-made');
  if(!date||bagsMade===0){showToast(t('batchErrDate2'),true);return;}
  const batch={
    date,batch_type:'fge',bags_made:bagsMade,
    fumaric_bags:gv('b2-fumaric-bags'),fumaric_lot:gt('b2-fumaric-lot'),
    guar_bags:gv('b2-guar-bags'),guar_lot:gt('b2-guar-lot'),
    enzyme_bags:gv('b2-enzyme-bags'),enzyme_lot:gt('b2-enzyme-lot'),
    notes:gt('batch2-notes')
  };
  showLoading('Saving batch‚Ä¶');
  try{
    const saved=await SB.insert('formula_batches',batch);
    batches.unshift({...batch,id:saved[0]?.id||Date.now()});
    ['batch2-date','batch2-bags-made','b2-fumaric-bags','b2-fumaric-lot','b2-guar-bags','b2-guar-lot','b2-enzyme-bags','b2-enzyme-lot','batch2-notes'].forEach(id=>{const el=g(id);if(el)el.value='';});
    g('batch2-date').value=new Date().toISOString().split('T')[0];
    renderBatchHistory();
    showToast(t('batchSaved2'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

function renderBatchHistory(){
  const el=g('batch-history-list');
  if(!batches.length){el.innerHTML=`<div class="empty-state" style="padding:20px;"><div class="empty-icon">üß™</div><div class="empty-text">${t('noBatches')}</div></div>`;return;}
  el.innerHTML=batches.slice(0,10).map(b=>{
    const isChemical=b.batch_type==='chemical';
    return`<div class="warehouse-item">
      <div class="warehouse-product">${isChemical?t('chemBatchLabel'):t('fgeBatchLabel')} ‚Äî ${b.date}</div>
      <div style="font-size:13px;color:var(--text2);">${isChemical?`${b.total_cases} ${t('casesCreated')} ¬∑ ${b.remaining_cases||b.total_cases} ${t('casesRemainingLabel')}`:`${b.bags_made} ${t('bagsMadeLabel')}`}</div>
      ${b.notes?`<div style="font-size:12px;color:var(--text3);margin-top:4px;">${b.notes}</div>`:''}
    </div>`;
  }).join('');
}

// ============================================================
// SHIPPING
// ============================================================
function addShipItem(){
  shipItemCount++;
  const div=document.createElement('div');
  div.className='item-entry';div.id='ship-item-'+shipItemCount;

  // Build product options grouped by product with available dates
  const stockMap=buildStockMap();
  let productOptions='<option value="">‚Äî Select Product ‚Äî</option>';
  const productsInStock=[...new Set(Object.keys(stockMap).map(k=>k.split('||')[0]))].sort();
  productsInStock.forEach(p=>{productOptions+=`<option value="${p}">${p}</option>`;});

  div.innerHTML=`
    <div class="item-entry-header">
      <div class="item-num">${t('shipItemLabel')} ${shipItemCount}</div>
      <button class="remove-btn" onclick="g('ship-item-${shipItemCount}').remove()">‚úï</button>
    </div>
    <div class="form-group"><label>${t('shipProductLabel')}</label>
      <select class="ship-product-select" onchange="updateShipDates(this,${shipItemCount})">${productOptions}</select>
    </div>
    <div class="form-group"><label>${t('shipProdDateLabel')}</label>
      <select id="ship-date-sel-${shipItemCount}"><option value="">‚Äî Select product first ‚Äî</option></select>
    </div>
    <div class="form-group"><label>${t('shipCasesLabel')}</label>
      <input type="number" inputmode="numeric" id="ship-cases-${shipItemCount}" placeholder="0">
    </div>`;
  g('ship-items-container').appendChild(div);
}

function updateShipDates(selectEl,num){
  const product=selectEl.value;
  const dateSel=g('ship-date-sel-'+num);
  if(!product){dateSel.innerHTML=`<option value="">${t('selectProductFirst')}</option>`;return;}
  const stockMap=buildStockMap();
  const dates=Object.keys(stockMap).filter(k=>k.startsWith(product+'||')).sort();
  if(!dates.length){dateSel.innerHTML=`<option value="">${t('noStockProduct')}</option>`;return;}
  dateSel.innerHTML=`<option value="">‚Äî Select date ‚Äî</option>`+
    dates.map(k=>{
      const[,date]=k.split('||');
      const avail=stockMap[k];
      return`<option value="${date}">${date} ‚Äî ${avail} cases available</option>`;
    }).join('');
}

function buildStockMap(){
  // produced per product+date
  const produced={};
  runs.forEach(r=>{
    const items=r.items||[];
    items.forEach(item=>{
      const key=`${item.name}||${r.date}`;
      produced[key]=(produced[key]||0)+(item.cases||0);
    });
  });
  // shipped per product+date
  const shipped={};
  shipments.forEach(s=>{
    const items=s.items||[];
    items.forEach(item=>{
      const key=`${item.product}||${item.production_date}`;
      shipped[key]=(shipped[key]||0)+(item.cases||0);
    });
  });
  // available = produced - shipped (only where >0)
  const available={};
  Object.keys(produced).forEach(k=>{
    const avail=produced[k]-(shipped[k]||0);
    if(avail>0)available[k]=avail;
  });
  return available;
}

async function saveShipment(){
  const date=gt('ship-date');
  const recipient=gt('ship-recipient');
  if(!date||!recipient){showToast(t('shipErrDate'),true);return;}

  const items=[];
  let totalCases=0;
  let valid=true;
  const stockMap=buildStockMap();

  document.querySelectorAll('#ship-items-container .item-entry').forEach(entry=>{
    const product=entry.querySelector('.ship-product-select')?.value||'';
    const prodDate=entry.querySelector('[id^="ship-date-sel-"]')?.value||'';
    const cases=parseFloat(entry.querySelector('[id^="ship-cases-"]')?.value)||0;
    if(!product||!prodDate||cases<=0){valid=false;return;}
    // Validate vs available stock
    const key=`${product}||${prodDate}`;
    const avail=stockMap[key]||0;
    if(cases>avail){showToast(`‚ö† Only ${avail} cases of ${product} (${prodDate}) available`,true);valid=false;}
    items.push({product,production_date:prodDate,cases});
    totalCases+=cases;
  });

  if(!valid)return;
  if(!items.length){showToast(t('shipErrItems'),true);return;}

  const shipment={
    date,recipient,po:gt('ship-po'),
    items_json:JSON.stringify(items),
    total_cases:totalCases,
    notes:gt('ship-notes')
  };

  showLoading(t('savingShipment')||'Saving‚Ä¶');
  try{
    const saved=await SB.insert('shipments',shipment);
    shipments.unshift({...shipment,id:saved[0]?.id||Date.now(),items,totalCases});
    g('ship-date').value=new Date().toISOString().split('T')[0];
    g('ship-recipient').value='';g('ship-po').value='';g('ship-notes').value='';
    g('ship-items-container').innerHTML='';shipItemCount=0;
    renderShipHistory();renderWarehouse();refreshDashboard();
    showToast(t('shipSaved'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

function setShipFilter(f,btn){shipFilter=f;document.querySelectorAll('#panel-ship .filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderShipHistory();}

function renderShipHistory(){
  const f=filterByDate(shipments,shipFilter);
  const body=g('ship-history-body');
  if(!f.length){body.innerHTML=`<tr><td colspan="5"><div class="empty-state"><div class="empty-icon">üöö</div><div class="empty-text">${t('noShipments')}</div></div></td></tr>`;return;}
  body.innerHTML=f.map(s=>`<tr>
    <td>${s.date}</td>
    <td>${s.recipient||'‚Äî'}</td>
    <td>${(s.items||[]).map(i=>`<span class="item-tag">${i.product}: ${i.cases} (${i.production_date})</span>`).join('')}</td>
    <td>${s.totalCases||s.total_cases}</td>
    <td><div style="display:flex;gap:5px;">
      <button class="btn-edit-row" onclick="openEditShip(${s.id})">‚úèÔ∏è</button>
      <button class="btn-del-row" onclick="deleteShipment(${s.id})" title="Delete">üóë</button>
    </div></td>
  </tr>`).join('');
}

async function deleteShipment(id){
  if(!confirm(t('deleteShipConfirm')||'Delete this shipment? Stock will be restored.'))return;
  const name=prompt(t('auditNamePrompt'));
  if(!name)return;
  const s=shipments.find(x=>x.id===id);
  showLoading('Deleting‚Ä¶');
  try{
    await SB.delete('shipments',id);
    await writeAudit({action:'DELETED',record_type:'Shipment',record_date:s?.date||'‚Äî',changed_by:name,diff:`Deleted shipment to ${s?.recipient||'‚Äî'}, ${s?.total_cases||0} cases`,changed_at:new Date().toISOString()});
    shipments=shipments.filter(x=>x.id!==id);
    renderShipHistory();renderWarehouse();refreshDashboard();
    showToast(t('shipDeleted'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

// ============================================================
// WAREHOUSE VIEW
// ============================================================
function setWarehouseView(v,btn){warehouseView=v;document.querySelectorAll('#panel-warehouse .filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderWarehouse();}

function renderWarehouse(){
  const stockMap=buildStockMapWithAudits();
  const el=g('warehouse-grid');

  if(!Object.keys(stockMap).length){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">üè≠</div><div class="empty-text">${t('noStockYet')}</div><div class="empty-sub">${t('noStockSub')}</div></div>`;
    return;
  }

  // Group by product
  const byProduct={};
  Object.keys(stockMap).forEach(k=>{
    const[product,date]=k.split('||');
    if(!byProduct[product])byProduct[product]=[];
    byProduct[product].push({date,available:stockMap[k]});
  });

  // Sort products, sort dates within each (FIFO = oldest first)
  let html='';
  Object.keys(byProduct).sort().forEach(product=>{
    if(warehouseView==='instock'&&byProduct[product].every(d=>d.available===0))return;
    const dates=byProduct[product].sort((a,b)=>a.date.localeCompare(b.date));
    const totalAvail=dates.reduce((s,d)=>s+d.available,0);
    html+=`<div class="warehouse-item">
      <div class="warehouse-product">${product} <span style="font-size:14px;color:var(--text3);font-weight:600;">‚Äî ${totalAvail} ${t('casesTotalLabel')}</span></div>
      ${dates.map(d=>{
        const cls=d.available>10?'positive':'positive';
        return`<div class="warehouse-date-row">
          <span style="color:var(--text2);font-size:13px;">üìÖ ${d.date}</span>
          <span class="item-tag ${d.available>5?'green':'accent'}" style="font-size:13px;">${d.available} cases</span>
        </div>`;
      }).join('')}
    </div>`;
  });
  el.innerHTML=html||`<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">${t('allShipped')}</div></div>`;
}

function exportWarehouse(){
  const stockMap=buildStockMapWithAudits();
  const rows=Object.keys(stockMap).sort().map(k=>{
    const[product,date]=k.split('||');
    return{[t('whColProduct')]:product,[t('whColDate')]:date,[t('whColAvail')]:stockMap[k]};
  });
  if(!rows.length){showToast(t('exportErrNoStock'),true);return;}
  dlExcel([{name:'Warehouse Stock',data:rows}],'Atotonilco_Warehouse_'+new Date().toISOString().split('T')[0]);
}

// ============================================================
// RECEIVE
// ============================================================
async function saveReceival(){
  const date=gt('recv-date');
  if(!date){showToast('‚ö† Enter a date',true);return;}
  const r={
    date,supplier:gt('recv-supplier'),po:gt('recv-po'),
    flour_lbs:gv('recv-flour-lbs'),flour_bags:gv('recv-flour-bags'),flour_lot:gt('recv-flour-lot'),
    ww_lbs:gv('recv-ww-lbs'),ww_bags:gv('recv-ww-bags'),ww_lot:gt('recv-ww-lot'),
    oil:gv('recv-oil'),oil_lot:gt('recv-oil-lot'),
    beta:gv('recv-beta'),beta_lot:gt('recv-beta-lot'),
    gordita:gv('recv-gordita'),gordita_lot:gt('recv-gordita-lot'),
    salt:gv('recv-salt'),salt_lot:gt('recv-salt-lot'),
    bakingp:gv('recv-bakingp'),bakingp_lot:gt('recv-bakingp-lot'),
    calcium:gv('recv-calcium'),calcium_lot:gt('recv-calcium-lot'),
    sodiump:gv('recv-sodiump'),sodiump_lot:gt('recv-sodiump-lot'),
    fumaric:gv('recv-fumaric'),fumaric_lot:gt('recv-fumaric-lot'),
    enzyme:gv('recv-enzyme'),enzyme_lot:gt('recv-enzyme-lot'),
    guar:gv('recv-guar'),guar_lot:gt('recv-guar-lot'),
    other:gt('recv-other'),notes:gt('recv-notes')
  };
  showLoading(t('savingReceipt')||'Saving‚Ä¶');
  try{
    const saved=await SB.insert('receipts',r);
    receipts.unshift({...r,id:saved[0]?.id||Date.now()});
    ['recv-date','recv-supplier','recv-po','recv-flour-lbs','recv-flour-bags','recv-flour-lot',
     'recv-ww-lbs','recv-ww-bags','recv-ww-lot','recv-oil','recv-oil-lot','recv-beta','recv-beta-lot',
     'recv-gordita','recv-gordita-lot','recv-salt','recv-salt-lot','recv-bakingp','recv-bakingp-lot',
     'recv-calcium','recv-calcium-lot','recv-sodiump','recv-sodiump-lot',
     'recv-fumaric','recv-fumaric-lot','recv-enzyme','recv-enzyme-lot',
     'recv-guar','recv-guar-lot','recv-other','recv-notes'].forEach(id=>{const el=g(id);if(el)el.value='';});
    g('recv-date').value=new Date().toISOString().split('T')[0];
    showToast(t('receiptSaved'));
    showTab('dash');
  }catch(err){showToast('‚ö† '+err.message,true);setSyncIndicator('err','‚ö† Offline');}
  finally{hideLoading();}
}

// ============================================================
// DASHBOARD
// ============================================================
function refreshDashboard(){
  const now=new Date(),weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
  const wr=runs.filter(r=>new Date(r.date)>=weekAgo);
  const wc=wr.reduce((a,r)=>a+(r.totalCases||r.total_cases||0),0);
  const wf=wr.reduce((a,r)=>a+(r.flour||0),0);
  const avg=wc>0?(wf/wc).toFixed(2):'‚Äî';
  g('stat-total-cases').textContent=wc||'0';
  g('stat-runs').textContent=wr.length||'0';
  g('stat-flour-used').textContent=wf?wf.toLocaleString():'0';
  g('stat-flour-ratio').textContent=avg!=='‚Äî'?avg:'‚Äî';

  // Finished goods table ‚Äî cases by product this week
  const productTotals={};
  wr.forEach(r=>{
    (r.items||[]).forEach(item=>{
      productTotals[item.name]=(productTotals[item.name]||0)+(item.cases||0);
    });
  });
  const fgEl=g('dash-fg-table');
  const sorted=Object.entries(productTotals).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length){fgEl.innerHTML=`<div class="empty-state" style="padding:20px;"><div class="empty-icon">üì¶</div><div class="empty-text">${t('noProdWeek')}</div></div>`;return;}
  fgEl.innerHTML=`<div class="log-wrapper"><table class="log-table"><thead><tr><th>Product</th><th>Cases</th><th>% of Total</th></tr></thead><tbody>
    ${sorted.map(([p,c])=>`<tr><td>${p}</td><td style="color:var(--accent);font-weight:800;">${c}</td><td style="color:var(--text3);">${wc>0?Math.round(c/wc*100):0}%</td></tr>`).join('')}
    <tr style="background:var(--surface2);"><td style="font-weight:800;">Total</td><td style="color:var(--accent);font-weight:900;">${wc}</td><td>‚Äî</td></tr>
  </tbody></table></div>`;

  // Discrepancy banner
  refreshDiscrepancyBanner();
  // Recent runs
  const rel=g('recent-runs-list');
  if(!runs.length){rel.innerHTML=`<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">${t('noRunsYet')}</div></div>`;return;}
  rel.innerHTML=runs.slice(0,5).map(r=>`
    <div class="inv-item" style="flex-direction:column;align-items:flex-start;gap:6px;">
      <div style="display:flex;justify-content:space-between;width:100%;align-items:center;">
        <span style="font-size:16px;font-weight:800;color:var(--text)">${r.date}</span>
        <span style="font-size:16px;font-weight:800;color:var(--accent)">${r.totalCases||r.total_cases||0} cases</span>
      </div>
      <div>${(r.items||[]).map(i=>`<span class="item-tag accent">${i.name}: ${i.cases}</span>`).join('')}</div>
      <div style="font-size:13px;color:var(--text3);">üåæ ${r.flour||0} lbs ¬∑ ${r.ratio||'‚Äî'} lbs/case ¬∑ Group ${r.product_group||'?'}</div>
    </div>`).join('');
}

// ============================================================
// HISTORY RENDER
// ============================================================
function setHistFilter(f,btn){histFilter=f;document.querySelectorAll('#hist-filter-bar .filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderHistory();}

function renderHistory(){
  const f=filterByDate(runs,histFilter);
  g('history-body').innerHTML=!f.length
    ?`<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">${t('noRuns')}</div></div></td></tr>`
    :f.map(r=>`<tr>
        <td>${r.date}</td><td>${r.shift||'‚Äî'}</td><td>${r.operator||'‚Äî'}</td>
        <td><span class="group-badge ${r.product_group||''}" style="font-size:11px;">${r.product_group||'‚Äî'}</span></td>
        <td>${(r.items||[]).map(i=>`<span class="item-tag">${i.name}: ${i.cases}</span>`).join('')}</td>
        <td>${r.totalCases||r.total_cases||0}</td>
        <td>${(r.flour||0).toLocaleString()}</td>
        <td>${r.ratio||'‚Äî'}</td>
        <td><div style="display:flex;gap:5px;">
          <button class="btn-edit-row" onclick="openEditRun(${r.id})">‚úèÔ∏è</button>
          <button class="btn-del-row" onclick="quickDeleteRun(${r.id})">üóë</button>
        </div></td>
      </tr>`).join('');

  g('receipt-body').innerHTML=!receipts.length
    ?`<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üì¶</div><div class="empty-text">${t('noReceipts')}</div></div></td></tr>`
    :receipts.map(r=>`<tr>
        <td>${r.date}</td><td>${r.supplier||'‚Äî'}</td><td>${r.po||'‚Äî'}</td>
        <td>${r.flour_lbs||'‚Äî'}</td><td>${r.flour_lot||'‚Äî'}</td>
        <td><div style="display:flex;gap:5px;">
          <button class="btn-edit-row" onclick="openEditReceipt(${r.id})">‚úèÔ∏è</button>
          <button class="btn-del-row" onclick="quickDeleteReceipt(${r.id})">üóë</button>
        </div></td>
      </tr>`).join('');
}

// ============================================================
// EDIT RUN MODAL
// ============================================================
function openEditRun(id){
  const r=runs.find(x=>x.id===id);if(!r)return;
  g('edit-run-id').value=id;
  g('edit-run-date').value=r.date||'';g('edit-run-shift').value=r.shift||'morning';
  g('edit-run-operator').value=r.operator||'';g('edit-run-notes').value=r.notes||'';
  g('edit-flour').value=r.flour||'';g('edit-lot-flour').value=r.lot_flour||'';
  g('edit-run-changed-by').value='';
  const container=g('edit-items-container');container.innerHTML='';editItemCount=0;
  (r.items||[]).forEach(item=>addEditItem(item.name,item.cases));
  if(!(r.items||[]).length)addEditItem();
  g('edit-run-modal').classList.remove('hidden');document.body.style.overflow='hidden';
}
function addEditItem(name='',cases=''){
  editItemCount++;
  const div=document.createElement('div');div.className='item-entry';div.id='edit-item-'+editItemCount;
  div.innerHTML=`<div class="item-entry-header"><div class="item-num">${t('itemLabel')} ${editItemCount}</div><button class="remove-btn" onclick="this.closest('.item-entry').remove()">‚úï</button></div>
    <div class="form-group"><label>Product</label><select class="edit-item-select">${PRODUCTS.map(p=>`<option value="${p}"${p===name?' selected':''}>${p}</option>`).join('')}</select></div>
    <div class="form-group"><label data-i18n="labelCases">Cases</label><input type="number" inputmode="numeric" class="edit-item-cases" value="${cases}" placeholder="0"></div>`;
  g('edit-items-container').appendChild(div);
}
function closeEditRun(){g('edit-run-modal').classList.add('hidden');document.body.style.overflow='';}
// egv/egt defined above as const

async function saveEditRun(){
  const id=parseInt(g('edit-run-id').value);
  const changedBy=egt('edit-run-changed-by');
  if(!egt('edit-run-date')){showToast(t('editErrDate'),true);return;}
  if(!changedBy){showToast(t('editErrName'),true);return;}
  const items=[];let totalCases=0;
  document.querySelectorAll('#edit-items-container .item-entry').forEach(entry=>{
    const name=entry.querySelector('.edit-item-select')?.value||'';
    const cases=parseFloat(entry.querySelector('.edit-item-cases')?.value)||0;
    if(name&&cases>0){items.push({name,cases});totalCases+=cases;}
  });
  const flour=egv('edit-flour');
  const updated={date:egt('edit-run-date'),shift:egt('edit-run-shift'),operator:egt('edit-run-operator'),notes:egt('edit-run-notes'),flour,lot_flour:egt('edit-lot-flour'),items_json:JSON.stringify(items),total_cases:totalCases,ratio:totalCases>0?(flour/totalCases).toFixed(2):'0'};
  showLoading('Saving‚Ä¶');
  try{
    const old=runs.find(x=>x.id===id)||{};
    await SB.update('production_runs',id,updated);
    await writeAudit({action:'EDITED',record_type:'Production Run',record_date:old.date||updated.date,changed_by:changedBy,diff:buildDiff(old,updated),changed_at:new Date().toISOString()});
    const idx=runs.findIndex(x=>x.id===id);
    if(idx!==-1)runs[idx]={...runs[idx],...updated,items,totalCases};
    closeEditRun();refreshDashboard();renderHistory();showToast(t('editRunSaved'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

async function confirmDeleteRun(){
  const id=parseInt(g('edit-run-id').value);
  const changedBy=egt('edit-run-changed-by');
  if(!changedBy){showToast(t('editErrNameDel'),true);return;}
  const run=runs.find(x=>x.id===id);
  if(!confirm(`${t('deleteRunConfirm')} ${run?.date||''}?\n${t('cannotUndo')}`))return;
  showLoading('Deleting‚Ä¶');
  try{
    await SB.delete('production_runs',id);
    await writeAudit({action:'DELETED',record_type:'Production Run',record_date:run?.date||'‚Äî',changed_by:changedBy,diff:`Deleted: ${run?.date||'?'} ¬∑ ${run?.totalCases||0} cases ¬∑ ${run?.flour||0} lbs flour`,changed_at:new Date().toISOString()});
    runs=runs.filter(x=>x.id!==id);closeEditRun();refreshDashboard();renderHistory();showToast(t('runDeleted'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

async function quickDeleteRun(id){
  const run=runs.find(x=>x.id===id);
  if(!confirm(`Delete run ${run?.date||''}?\nThis cannot be undone.`))return;
  const name=prompt('Your name (for audit log):');if(!name)return;
  showLoading('Deleting‚Ä¶');
  try{
    await SB.delete('production_runs',id);
    await writeAudit({action:'DELETED',record_type:'Production Run',record_date:run?.date||'‚Äî',changed_by:name,diff:`Quick deleted: ${run?.date||'?'} ¬∑ ${run?.totalCases||0} cases`,changed_at:new Date().toISOString()});
    runs=runs.filter(x=>x.id!==id);refreshDashboard();renderHistory();showToast('‚úì Run deleted');
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

// ============================================================
// EDIT RECEIPT MODAL
// ============================================================
function openEditReceipt(id){
  const r=receipts.find(x=>x.id===id);if(!r)return;
  g('edit-receipt-id').value=id;
  g('edit-recv-date').value=r.date||'';g('edit-recv-supplier').value=r.supplier||'';
  g('edit-recv-po').value=r.po||'';g('edit-recv-flour-lbs').value=r.flour_lbs||'';
  g('edit-recv-flour-bags').value=r.flour_bags||'';g('edit-recv-flour-lot').value=r.flour_lot||'';
  g('edit-recv-oil').value=r.oil||'';g('edit-recv-oil-lot').value=r.oil_lot||'';
  g('edit-recv-beta').value=r.beta||'';g('edit-recv-beta-lot').value=r.beta_lot||'';
  g('edit-recv-other').value=r.other||'';g('edit-recv-notes').value=r.notes||'';
  g('edit-recv-changed-by').value='';
  g('edit-receipt-modal').classList.remove('hidden');document.body.style.overflow='hidden';
}
function closeEditReceipt(){g('edit-receipt-modal').classList.add('hidden');document.body.style.overflow='';}

async function saveEditReceipt(){
  const id=parseInt(g('edit-receipt-id').value);
  const changedBy=egt('edit-recv-changed-by');
  if(!egt('edit-recv-date')){showToast(t('editErrDate'),true);return;}
  if(!changedBy){showToast(t('editErrName'),true);return;}
  const updated={date:egt('edit-recv-date'),supplier:egt('edit-recv-supplier'),po:egt('edit-recv-po'),flour_lbs:egv('edit-recv-flour-lbs'),flour_bags:egv('edit-recv-flour-bags'),flour_lot:egt('edit-recv-flour-lot'),oil:egv('edit-recv-oil'),oil_lot:egt('edit-recv-oil-lot'),beta:egv('edit-recv-beta'),beta_lot:egt('edit-recv-beta-lot'),other:egt('edit-recv-other'),notes:egt('edit-recv-notes')};
  showLoading('Saving‚Ä¶');
  try{
    const old=receipts.find(x=>x.id===id)||{};
    await SB.update('receipts',id,updated);
    await writeAudit({action:'EDITED',record_type:'Receipt',record_date:old.date||updated.date,changed_by:changedBy,diff:buildDiff(old,updated),changed_at:new Date().toISOString()});
    const idx=receipts.findIndex(x=>x.id===id);
    if(idx!==-1)receipts[idx]={...receipts[idx],...updated};
    closeEditReceipt();renderHistory();showToast(t('editRecSaved'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

async function confirmDeleteReceipt(){
  const id=parseInt(g('edit-receipt-id').value);
  const changedBy=egt('edit-recv-changed-by');
  if(!changedBy){showToast('‚ö† Enter your name in Changed By before deleting',true);return;}
  const rec=receipts.find(x=>x.id===id);
  if(!confirm(`${t('deleteRecConfirm')} ${rec?.date||''}?\n${t('cannotUndo')}`))return;
  showLoading('Deleting‚Ä¶');
  try{
    await SB.delete('receipts',id);
    await writeAudit({action:'DELETED',record_type:'Receipt',record_date:rec?.date||'‚Äî',changed_by:changedBy,diff:`Deleted receipt: ${rec?.date||'?'} ¬∑ ${rec?.flour_lbs||0} lbs flour`,changed_at:new Date().toISOString()});
    receipts=receipts.filter(x=>x.id!==id);closeEditReceipt();renderHistory();showToast(t('receiptDeleted'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

async function quickDeleteReceipt(id){
  const rec=receipts.find(x=>x.id===id);
  if(!confirm(`Delete receipt ${rec?.date||''}?\nThis cannot be undone.`))return;
  const name=prompt('Your name (for audit log):');if(!name)return;
  showLoading('Deleting‚Ä¶');
  try{
    await SB.delete('receipts',id);
    await writeAudit({action:'DELETED',record_type:'Receipt',record_date:rec?.date||'‚Äî',changed_by:name,diff:`Quick deleted receipt: ${rec?.date||'?'} ¬∑ ${rec?.flour_lbs||0} lbs`,changed_at:new Date().toISOString()});
    receipts=receipts.filter(x=>x.id!==id);renderHistory();showToast('‚úì Receipt deleted');
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

// ============================================================
// EXPORT
// ============================================================
function dlExcel(sheets,fname){
  const wb=XLSX.utils.book_new();
  sheets.forEach(s=>{const ws=XLSX.utils.json_to_sheet(s.data);ws['!cols']=Object.keys(s.data[0]||{}).map(()=>({wch:18}));XLSX.utils.book_append_sheet(wb,ws,s.name);});
  XLSX.writeFile(wb,fname+'.xlsx');showToast('‚úì Downloaded: '+fname+'.xlsx');
}

function runsToRows(data){
  return data.map(r=>({
    'Date':r.date,'Shift':r.shift||'','Operator':r.operator||'','Group':r.product_group||'',
    'Items':(r.items||[]).map(i=>i.name+': '+i.cases+' cases').join(' | '),
    'Total Cases':r.totalCases||r.total_cases||0,
    'Flour (lbs)':r.flour||0,'Silos':r.silos_json||'','lbs/case':r.ratio||'',
    'Oil (cases)':r.oil||0,'Oil Lot':r.lot_oil||'',
    'Beta Tablets':r.beta||0,'Beta Lot':r.lot_beta||'',
    'Notes':r.notes||''
  }));
}

function shipmentsToRows(data){
  const rows=[];
  data.forEach(s=>{
    (s.items||[]).forEach(item=>{
      rows.push({'Shipment Date':s.date,'Recipient':s.recipient||'','PO':s.po||'','Product':item.product,'Production Date':item.production_date,'Cases Shipped':item.cases,'Shipment Notes':s.notes||''});
    });
  });
  return rows;
}

function receiptsToRows(data){
  return data.map(r=>({'Date':r.date,'Supplier':r.supplier||'','PO':r.po||'','Flour (lbs)':r.flour_lbs||0,'Flour Bags':r.flour_bags||0,'Flour Lot':r.flour_lot||'','WW Flour (lbs)':r.ww_lbs||0,'WW Lot':r.ww_lot||'','Oil (cases)':r.oil||0,'Oil Lot':r.oil_lot||'','Beta':r.beta||0,'Beta Lot':r.beta_lot||'','Gordita':r.gordita||0,'Salt Bags':r.salt||0,'Baking P Bags':r.bakingp||0,'Calcium Bags':r.calcium||0,'Sodium P Bags':r.sodiump||0,'Fumaric Bags':r.fumaric||0,'Enzyme Bags':r.enzyme||0,'Guar Bags':r.guar||0,'Other':r.other||'','Notes':r.notes||''}));
}

function batchesToRows(data){
  return data.map(b=>b.batch_type==='chemical'
    ?{'Date':b.date,'Type':'Chemical Batch','Cases Created':b.total_cases||0,'Cases Remaining':b.remaining_cases||b.total_cases||0,'Calcium Bags':b.calcium_bags||0,'Calcium Lot':b.calcium_lot||'','Sodium Bags':b.sodium_bags||0,'Sodium Lot':b.sodium_lot||'','Baking Bags':b.baking_bags||0,'Baking Lot':b.baking_lot||'','Salt Bags':b.salt_bags||0,'Salt Lot':b.salt_lot||'','Notes':b.notes||''}
    :{'Date':b.date,'Type':'FGE Blend','Bags Made':b.bags_made||0,'Fumaric Bags':b.fumaric_bags||0,'Fumaric Lot':b.fumaric_lot||'','Guar Bags':b.guar_bags||0,'Guar Lot':b.guar_lot||'','Enzyme Bags':b.enzyme_bags||0,'Enzyme Lot':b.enzyme_lot||'','Notes':b.notes||''});
}

function exportRuns(p){const d=filterByDate(runs,p);if(!d.length){showToast(t('exportErrNoData'),true);return;}dlExcel([{name:'Production Runs',data:runsToRows(d)}],'Atotonilco_Runs_'+getLabel(p));}
function exportShipments(p){const d=filterByDate(shipments,p);if(!d.length){showToast(t('exportErrNoShipments'),true);return;}const rows=shipmentsToRows(d);if(!rows.length){showToast('‚ö† No data',true);return;}dlExcel([{name:'Shipments',data:rows}],'Atotonilco_Shipments_'+getLabel(p));}
function exportReceipts(p){const d=filterByDate(receipts,p);if(!d.length){showToast(t('exportErrNoReceipts'),true);return;}dlExcel([{name:'Receipts',data:receiptsToRows(d)}],'Atotonilco_Receipts_'+getLabel(p));}
function exportBatches(p){const d=filterByDate(batches,p);if(!d.length){showToast(t('exportErrNoBatches'),true);return;}dlExcel([{name:'Formula Batches',data:batchesToRows(d)}],'Atotonilco_Batches_'+getLabel(p));}

function exportCustomRange(){
  const start=gt('export-start'),end=gt('export-end');
  if(!start&&!end){showToast(t('exportErrNoRange'),true);return;}
  const rRuns=filterByRange(runs,start,end);
  const rShip=filterByRange(shipments,start,end);
  const rReceipts=filterByRange(receipts,start,end);
  const sheets=[];
  if(rRuns.length)sheets.push({name:'Production Runs',data:runsToRows(rRuns)});
  if(rShip.length){const rows=shipmentsToRows(rShip);if(rows.length)sheets.push({name:'Shipments',data:rows});}
  if(rReceipts.length)sheets.push({name:'Receipts',data:receiptsToRows(rReceipts)});
  if(!sheets.length){showToast(t('exportErrNoRange2'),true);return;}
  dlExcel(sheets,'Atotonilco_Range_'+(start||'start')+'_to_'+(end||'end'));
}

function exportFull(p){
  const sheets=[];
  const rr=filterByDate(runs,p);if(rr.length)sheets.push({name:'Production Runs',data:runsToRows(rr)});
  const rs=filterByDate(shipments,p);const srows=shipmentsToRows(rs);if(srows.length)sheets.push({name:'Shipments',data:srows});
  const rc=filterByDate(receipts,p);if(rc.length)sheets.push({name:'Receipts',data:receiptsToRows(rc)});
  const rb=filterByDate(batches,p);if(rb.length)sheets.push({name:'Formula Batches',data:batchesToRows(rb)});
  if(!sheets.length){showToast('‚ö† No data',true);return;}
  dlExcel(sheets,'Atotonilco_FullReport_'+getLabel(p));
}

// ============================================================
// AUDIT LOG
// ============================================================
function auditPinPress(d){if(auditPinBuf.length>=4)return;auditPinBuf+=d;updateAuditDots(auditPinBuf.length,false);if(auditPinBuf.length===4)setTimeout(checkAuditPin,120);}
function auditPinDel(){auditPinBuf=auditPinBuf.slice(0,-1);updateAuditDots(auditPinBuf.length,false);}
function updateAuditDots(count,error){for(let i=0;i<4;i++){const d=document.getElementById('adot-'+i);if(d)d.className='audit-pin-dot'+(i<count?(error?' error':' filled'):'');}}
function checkAuditPin(){
  if(auditPinBuf===AUDIT_PIN){auditUnlocked=true;g('audit-gate').style.display='none';g('audit-content').style.display='block';loadAuditLogs();}
  else{updateAuditDots(4,true);g('audit-pin-err').textContent=t('auditPinErr');setTimeout(()=>{auditPinBuf='';updateAuditDots(0,false);g('audit-pin-err').textContent='';},1200);}
}
function lockAuditLog(){auditUnlocked=false;auditPinBuf='';updateAuditDots(0,false);g('audit-gate').style.display='';g('audit-content').style.display='none';const tab=g('tab-audit');if(tab)tab.style.display='none';showTab('dash');}
function revealAuditTab(){const tab=g('tab-audit');if(tab){tab.style.display='';showTab('audit');}}

function buildDiff(oldObj,newObj){
  const changes=[];
  Object.keys(newObj).forEach(k=>{
    const ov=oldObj[k],nv=newObj[k];
    if(String(ov)!==String(nv)&&nv!==undefined){
      changes.push(`${k}: "${ov||'‚Äî'}" ‚Üí "${nv||'‚Äî'}"`);
    }
  });
  return changes.length?changes.slice(0,5).join(' | '):'(no changes)';
}

async function writeAudit(entry){
  try{await SB.insert('audit_log',entry);auditLogs.unshift(entry);}
  catch(err){console.warn('Audit write failed:',err.message);}
}

function buildDiff(oldObj,newObj){
  const LABELS={date:'Date',shift:'Shift',operator:'Operator',flour:'Flour (lbs)',lot_flour:'Flour Lot',water:'Water',oil:'Oil',lot_oil:'Oil Lot',beta:'Beta',lot_beta:'Beta Lot',total_cases:'Total Cases',ratio:'lbs/case',notes:'Notes',supplier:'Supplier',po:'PO',flour_lbs:'Flour (lbs)',flour_lot:'Flour Lot'};
  const changes=[];
  const keys=new Set([...Object.keys(oldObj||{}),...Object.keys(newObj||{})]);
  keys.forEach(k=>{
    if(['id','created_at','updated_at','items','items_json','silos_json'].includes(k))return;
    const ov=String(oldObj?.[k]??'');const nv=String(newObj?.[k]??'');
    if(ov!==nv)changes.push(`${LABELS[k]||k}: "${ov}" ‚Üí "${nv}"`);
  });
  return changes.join(' | ')||'No changes detected';
}

function setAuditFilter(f,btn){auditFilter=f;document.querySelectorAll('#panel-audit .filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderAuditLog();}

async function loadAuditLogs(){
  showLoading('Loading audit log‚Ä¶');
  try{auditLogs=await SB.get('audit_log','&limit=1000');renderAuditLog();}
  catch(err){showToast('‚ö† Could not load audit log',true);}
  finally{hideLoading();}
}

function renderAuditLog(){
  const f=filterByDate(auditLogs,auditFilter);
  const edits=f.filter(a=>a.action==='EDITED').length;
  const dels=f.filter(a=>a.action==='DELETED').length;
  g('audit-summary').innerHTML=`<span class="audit-badge edited">‚úèÔ∏è ${edits} Edits</span><span class="audit-badge deleted">üóë ${dels} Deletions</span><span style="font-size:13px;color:var(--text3);padding:4px;">${f.length} total</span>`;
  const body=g('audit-body');
  if(!f.length){body.innerHTML=`<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-text">${t('auditNoRecords')}</div></div></td></tr>`;return;}
  body.innerHTML=f.map(a=>{
    const ts=a.changed_at?new Date(a.changed_at).toLocaleString():'‚Äî';
    const badge=a.action==='DELETED'?`<span class="audit-badge deleted">üóë DELETED</span>`:`<span class="audit-badge edited">‚úèÔ∏è EDITED</span>`;
    const diff=(a.diff||'‚Äî').length>120?(a.diff||'').slice(0,120)+'‚Ä¶':a.diff||'‚Äî';
    return`<tr><td style="font-size:13px;white-space:nowrap;">${ts}</td><td>${badge}</td><td style="font-weight:700;">${a.record_type||'‚Äî'}</td><td>${a.record_date||'‚Äî'}</td><td style="color:var(--accent);font-weight:700;">${a.changed_by||'‚Äî'}</td><td style="font-size:12px;color:var(--text2);">${diff}</td></tr>`;
  }).join('');
}

function exportAuditLog(){
  const f=filterByDate(auditLogs,auditFilter);
  if(!f.length){showToast('‚ö† No audit records',true);return;}
  dlExcel([{name:'Audit Log',data:f.map(a=>({'Date & Time':a.changed_at?new Date(a.changed_at).toLocaleString():'‚Äî','Action':a.action||'‚Äî','Record Type':a.record_type||'‚Äî','Record Date':a.record_date||'‚Äî','Changed By':a.changed_by||'‚Äî','What Changed':a.diff||'‚Äî'}))}],'Atotonilco_AuditLog_'+new Date().toISOString().split('T')[0]);
}

// ============================================================
// DB STATUS
// ============================================================
function updateDbStatusBox(){
  g('db-status-box').innerHTML=`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <span style="font-size:20px;">${dbConnected?'‚úÖ':'‚ùå'}</span>
      <span style="font-weight:800;">${dbConnected?t('dbConnected'):t('dbNotConnected')}</span>
    </div>
    <div style="margin-top:8px;font-size:13px;color:var(--text3);">${t('tabLog')}: ${runs.length} ¬∑ ${t('tabReceive')}: ${receipts.length} ¬∑ ${t('tabShip')}: ${shipments.length} ¬∑ ${t('tabBatch')}: ${batches.length}</div>`;
}

// ============================================================
// HISTORY ‚Äî BATCH & SHIP TABLE RENDERS
// ============================================================
function setBatchHistFilter(f,btn){batchHistFilter=f;document.querySelectorAll('#batch-hist-filter-bar .filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderBatchHistTable();}
function setShipHistFilter(f,btn){shipHistFilter=f;document.querySelectorAll('#ship-hist-filter-bar .filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderShipHistTable();}

function renderBatchHistTable(){
  const f=filterByDate(batches,batchHistFilter);
  const body=g('batch-hist-body');
  if(!body)return;
  if(!f.length){body.innerHTML=`<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üß™</div><div class="empty-text">${t('noBatches')}</div></div></td></tr>`;return;}
  body.innerHTML=f.map(b=>{
    const isC=(b.batch_type==='chemical');
    const qty=isC?`${b.total_cases} cases`:`${b.bags_made} bags`;
    const ings=isC
      ?[b.calcium_bags&&`Calcium ${b.calcium_bags}bg`,b.sodium_bags&&`Sodium ${b.sodium_bags}bg`,b.baking_bags&&`Baking ${b.baking_bags}bg`,b.salt_bags&&`Salt ${b.salt_bags}bg`].filter(Boolean).join(', ')
      :[b.fumaric_bags&&`Fumaric ${b.fumaric_bags}bg`,b.guar_bags&&`Guar ${b.guar_bags}bg`,b.enzyme_bags&&`Enzyme ${b.enzyme_bags}bg`].filter(Boolean).join(', ');
    return`<tr>
      <td>${b.date}</td>
      <td><span class="item-tag ${isC?'accent':''}">${isC?'Chemical':'FGE'}</span></td>
      <td style="color:var(--accent);font-weight:800;">${qty}</td>
      <td style="font-size:12px;">${ings||'‚Äî'}</td>
      <td style="font-size:12px;color:var(--text3);">${b.notes||'‚Äî'}</td>
      <td><button class="btn-edit-row" onclick="openEditBatch(${b.id})">‚úèÔ∏è</button></td>
    </tr>`;
  }).join('');
}

function renderShipHistTable(){
  const f=filterByDate(shipments,shipHistFilter);
  const body=g('ship-hist-body');
  if(!body)return;
  if(!f.length){body.innerHTML=`<tr><td colspan="5"><div class="empty-state"><div class="empty-icon">üöö</div><div class="empty-text">${t('noShipments')}</div></div></td></tr>`;return;}
  body.innerHTML=f.map(s=>`<tr>
    <td>${s.date}</td>
    <td>${s.recipient||'‚Äî'}</td>
    <td>${(s.items||[]).map(i=>`<span class="item-tag">${i.product}: ${i.cases} (${i.production_date})</span>`).join('')}</td>
    <td>${s.totalCases||s.total_cases||0}</td>
    <td><div style="display:flex;gap:5px;">
      <button class="btn-edit-row" onclick="openEditShip(${s.id})">‚úèÔ∏è</button>
      <button class="btn-del-row" onclick="deleteShipment(${s.id})">üóë</button>
    </div></td>
  </tr>`).join('');
}

// ============================================================
// EDIT BATCH MODAL
// ============================================================
function openEditBatch(id){
  const b=batches.find(x=>x.id===id);if(!b)return;
  g('edit-batch-id').value=id;
  g('edit-batch-type').value=b.batch_type;
  g('edit-batch-date').value=b.date||'';
  g('edit-batch-notes').value=b.notes||'';
  g('edit-batch-changed-by').value='';
  const qtyWrap=g('edit-batch-qty-wrap');
  const ingsEl=g('edit-batch-ings');
  if(b.batch_type==='chemical'){
    qtyWrap.innerHTML=`<div class="form-group"><label>Total Cases Created</label><input type="number" inputmode="numeric" id="ebi-cases" value="${b.total_cases||0}"></div>`;
    ingsEl.innerHTML=`
      <div class="form-row-2">
        <div class="form-group"><label>Calcium Propionate Bags</label><input type="number" inputmode="decimal" id="ebi-calcium-bags" value="${b.calcium_bags||0}"></div>
        <div class="form-group"><label>Lot #</label><input type="text" id="ebi-calcium-lot" value="${b.calcium_lot||''}"></div>
      </div>
      <div class="form-row-2">
        <div class="form-group"><label>Sodium Propionate Bags</label><input type="number" inputmode="decimal" id="ebi-sodium-bags" value="${b.sodium_bags||0}"></div>
        <div class="form-group"><label>Lot #</label><input type="text" id="ebi-sodium-lot" value="${b.sodium_lot||''}"></div>
      </div>
      <div class="form-row-2">
        <div class="form-group"><label>Baking Powder Bags</label><input type="number" inputmode="decimal" id="ebi-baking-bags" value="${b.baking_bags||0}"></div>
        <div class="form-group"><label>Lot #</label><input type="text" id="ebi-baking-lot" value="${b.baking_lot||''}"></div>
      </div>
      <div class="form-row-2">
        <div class="form-group"><label>Salt Bags</label><input type="number" inputmode="decimal" id="ebi-salt-bags" value="${b.salt_bags||0}"></div>
        <div class="form-group"><label>Lot #</label><input type="text" id="ebi-salt-lot" value="${b.salt_lot||''}"></div>
      </div>`;
  } else {
    qtyWrap.innerHTML=`<div class="form-group"><label>Bags Made</label><input type="number" inputmode="numeric" id="ebi-bags-made" value="${b.bags_made||0}"></div>`;
    ingsEl.innerHTML=`
      <div class="form-row-2">
        <div class="form-group"><label>Fumaric Acid Bags</label><input type="number" inputmode="decimal" id="ebi-fumaric-bags" value="${b.fumaric_bags||0}"></div>
        <div class="form-group"><label>Lot #</label><input type="text" id="ebi-fumaric-lot" value="${b.fumaric_lot||''}"></div>
      </div>
      <div class="form-row-2">
        <div class="form-group"><label>Guar Gum Bags</label><input type="number" inputmode="decimal" id="ebi-guar-bags" value="${b.guar_bags||0}"></div>
        <div class="form-group"><label>Lot #</label><input type="text" id="ebi-guar-lot" value="${b.guar_lot||''}"></div>
      </div>
      <div class="form-row-2">
        <div class="form-group"><label>Enzyme Blend Bags</label><input type="number" inputmode="decimal" id="ebi-enzyme-bags" value="${b.enzyme_bags||0}"></div>
        <div class="form-group"><label>Lot #</label><input type="text" id="ebi-enzyme-lot" value="${b.enzyme_lot||''}"></div>
      </div>`;
  }
  g('edit-batch-modal').classList.remove('hidden');document.body.style.overflow='hidden';
}
function closeEditBatch(){g('edit-batch-modal').classList.add('hidden');document.body.style.overflow='';}

async function saveEditBatch(){
  const id=parseInt(g('edit-batch-id').value);
  const btype=g('edit-batch-type').value;
  const changedBy=egt('edit-batch-changed-by');
  const date=egt('edit-batch-date');
  if(!date){showToast(t('editErrDate'),true);return;}
  if(!changedBy){showToast(t('editErrName'),true);return;}
  const old=batches.find(x=>x.id===id)||{};
  let updated={date,notes:egt('edit-batch-notes')};
  if(btype==='chemical'){
    const cases=egv('ebi-cases');
    Object.assign(updated,{total_cases:cases,remaining_cases:cases,
      calcium_bags:egv('ebi-calcium-bags'),calcium_lot:egt('ebi-calcium-lot'),
      sodium_bags:egv('ebi-sodium-bags'),sodium_lot:egt('ebi-sodium-lot'),
      baking_bags:egv('ebi-baking-bags'),baking_lot:egt('ebi-baking-lot'),
      salt_bags:egv('ebi-salt-bags'),salt_lot:egt('ebi-salt-lot')});
  } else {
    Object.assign(updated,{bags_made:egv('ebi-bags-made'),
      fumaric_bags:egv('ebi-fumaric-bags'),fumaric_lot:egt('ebi-fumaric-lot'),
      guar_bags:egv('ebi-guar-bags'),guar_lot:egt('ebi-guar-lot'),
      enzyme_bags:egv('ebi-enzyme-bags'),enzyme_lot:egt('ebi-enzyme-lot')});
  }
  showLoading('Saving‚Ä¶');
  try{
    await SB.update('formula_batches',id,updated);
    await writeAudit({action:'EDITED',record_type:'Formula Batch',record_date:old.date||date,changed_by:changedBy,diff:buildDiff(old,updated),changed_at:new Date().toISOString()});
    const idx=batches.findIndex(x=>x.id===id);
    if(idx!==-1)batches[idx]={...batches[idx],...updated};
    closeEditBatch();renderBatchHistory();renderBatchHistTable();
    showToast('‚úì Batch updated!');
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

async function confirmDeleteBatch(){
  const id=parseInt(g('edit-batch-id').value);
  const changedBy=egt('edit-batch-changed-by');
  if(!changedBy){showToast(t('editErrNameDel'),true);return;}
  const b=batches.find(x=>x.id===id);
  if(!confirm(`Delete this batch (${b?.date||'?'})?\n${t('cannotUndo')}`))return;
  showLoading('Deleting‚Ä¶');
  try{
    await SB.delete('formula_batches',id);
    await writeAudit({action:'DELETED',record_type:'Formula Batch',record_date:b?.date||'‚Äî',changed_by:changedBy,diff:`Deleted ${b?.batch_type==='chemical'?'Chemical':'FGE'} batch: ${b?.date||'?'}`,changed_at:new Date().toISOString()});
    batches=batches.filter(x=>x.id!==id);
    closeEditBatch();renderBatchHistory();renderBatchHistTable();
    showToast('‚úì Batch deleted');
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

// ============================================================
// EDIT SHIPMENT MODAL
// ============================================================
function openEditShip(id){
  const s=shipments.find(x=>x.id===id);if(!s)return;
  g('edit-ship-id').value=id;
  g('edit-ship-date').value=s.date||'';
  g('edit-ship-recipient').value=s.recipient||'';
  g('edit-ship-po').value=s.po||'';
  g('edit-ship-notes').value=s.notes||'';
  g('edit-ship-changed-by').value='';
  const itemsEl=g('edit-ship-items');
  itemsEl.innerHTML=(s.items||[]).map((item,i)=>`
    <div class="ing-row" style="margin-bottom:10px;">
      <div style="font-size:13px;font-weight:800;color:var(--accent);margin-bottom:8px;">Item ${i+1}</div>
      <div class="form-row-3">
        <div class="form-group"><label>Product</label><input type="text" id="esi-product-${i}" value="${item.product||''}"></div>
        <div class="form-group"><label>Production Date</label><input type="date" id="esi-date-${i}" value="${item.production_date||''}"></div>
        <div class="form-group"><label>Cases</label><input type="number" inputmode="numeric" id="esi-cases-${i}" value="${item.cases||0}"></div>
      </div>
    </div>`).join('');
  g('edit-ship-modal').classList.remove('hidden');document.body.style.overflow='hidden';
}
function closeEditShip(){g('edit-ship-modal').classList.add('hidden');document.body.style.overflow='';}

async function saveEditShip(){
  const id=parseInt(g('edit-ship-id').value);
  const changedBy=egt('edit-ship-changed-by');
  const date=egt('edit-ship-date');
  if(!date){showToast(t('editErrDate'),true);return;}
  if(!changedBy){showToast(t('editErrName'),true);return;}
  const old=shipments.find(x=>x.id===id)||{};
  // Collect updated items
  const items=[];let totalCases=0;
  const itemEls=g('edit-ship-items').querySelectorAll('.ing-row');
  itemEls.forEach((el,i)=>{
    const product=document.getElementById('esi-product-'+i)?.value||'';
    const production_date=document.getElementById('esi-date-'+i)?.value||'';
    const cases=parseFloat(document.getElementById('esi-cases-'+i)?.value)||0;
    if(product&&production_date&&cases>0){items.push({product,production_date,cases});totalCases+=cases;}
  });
  const updated={date,recipient:egt('edit-ship-recipient'),po:egt('edit-ship-po'),notes:egt('edit-ship-notes'),items_json:JSON.stringify(items),total_cases:totalCases};
  showLoading('Saving‚Ä¶');
  try{
    await SB.update('shipments',id,updated);
    await writeAudit({action:'EDITED',record_type:'Shipment',record_date:old.date||date,changed_by:changedBy,diff:buildDiff({date:old.date,recipient:old.recipient,total_cases:old.total_cases},{date:updated.date,recipient:updated.recipient,total_cases:updated.total_cases})+' | Items updated',changed_at:new Date().toISOString()});
    const idx=shipments.findIndex(x=>x.id===id);
    if(idx!==-1)shipments[idx]={...shipments[idx],...updated,items,totalCases};
    closeEditShip();renderShipHistory();renderShipHistTable();renderWarehouse();refreshDashboard();
    showToast('‚úì Shipment updated!');
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

async function confirmDeleteShipFromModal(){
  const id=parseInt(g('edit-ship-id').value);
  const changedBy=egt('edit-ship-changed-by');
  if(!changedBy){showToast(t('editErrNameDel'),true);return;}
  const s=shipments.find(x=>x.id===id);
  if(!confirm(`Delete shipment to ${s?.recipient||'?'} (${s?.date||'?'})?\n${t('cannotUndo')}`))return;
  showLoading('Deleting‚Ä¶');
  try{
    await SB.delete('shipments',id);
    await writeAudit({action:'DELETED',record_type:'Shipment',record_date:s?.date||'‚Äî',changed_by:changedBy,diff:`Deleted shipment to ${s?.recipient||'‚Äî'}, ${s?.total_cases||0} cases`,changed_at:new Date().toISOString()});
    shipments=shipments.filter(x=>x.id!==id);
    closeEditShip();renderShipHistory();renderShipHistTable();renderWarehouse();refreshDashboard();
    showToast(t('shipDeleted'));
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

// ============================================================
// WAREHOUSE AUDIT
// ============================================================
function populateAuditProductDropdown(){
  const sel=g('audit-product');
  if(!sel)return;
  const stockMap=buildStockMap();
  const products=[...new Set(Object.keys(stockMap).map(k=>k.split('||')[0]))].sort();
  // Also include all products that have ever been produced (even if stock=0)
  const allProduced=[...new Set(runs.flatMap(r=>(r.items||[]).map(i=>i.name)))].sort();
  const combined=[...new Set([...products,...allProduced])].sort();
  sel.innerHTML='<option value="">‚Äî Select Product ‚Äî</option>'+combined.map(p=>`<option value="${p}">${p}</option>`).join('');
  g('audit-prod-date').innerHTML='<option value="">‚Äî Select product first ‚Äî</option>';
  g('audit-system-balance').style.display='none';
  g('audit-diff-display').style.display='none';
  g('audit-reason-group').style.display='none';
}

function loadAuditDates(){
  const product=g('audit-product')?.value||'';
  const dateSel=g('audit-prod-date');
  const balanceBox=g('audit-system-balance');
  if(!product){dateSel.innerHTML='<option value="">‚Äî Select product first ‚Äî</option>';balanceBox.style.display='none';return;}
  // Get all production dates for this product (not just positive stock)
  const prodDates=[...new Set(runs.filter(r=>(r.items||[]).some(i=>i.name===product)).map(r=>r.date))].sort().reverse();
  if(!prodDates.length){dateSel.innerHTML='<option value="">‚Äî No production runs found ‚Äî</option>';return;}
  dateSel.innerHTML='<option value="">‚Äî Select date ‚Äî</option>'+prodDates.map(d=>{
    const stockMap=buildStockMap();
    const avail=stockMap[`${product}||${d}`]||0;
    return`<option value="${d}">${d} ‚Äî ${avail} cases available</option>`;
  }).join('');
}

function showAuditSystemBalance(){
  const product=g('audit-product')?.value||'';
  const date=g('audit-prod-date')?.value||'';
  const balanceBox=g('audit-system-balance');
  if(!product||!date){balanceBox.style.display='none';return;}
  const stockMap=buildStockMap();
  const sysQty=stockMap[`${product}||${date}`]||0;
  g('audit-system-qty').textContent=sysQty;
  balanceBox.style.display='block';
  showAuditDiff();
}

function showAuditDiff(){
  const product=g('audit-product')?.value||'';
  const date=g('audit-prod-date')?.value||'';
  const physical=parseFloat(g('audit-physical-count')?.value)||0;
  const diffEl=g('audit-diff-display');
  const reasonGroup=g('audit-reason-group');
  if(!product||!date){diffEl.style.display='none';reasonGroup.style.display='none';return;}
  const stockMap=buildStockMap();
  const sysQty=stockMap[`${product}||${date}`]||0;
  const diff=physical-sysQty;
  if(physical===0&&!g('audit-physical-count')?.value){diffEl.style.display='none';reasonGroup.style.display='none';return;}
  diffEl.style.display='block';
  if(diff===0){
    diffEl.style.background='#1a3a2a';diffEl.style.color='var(--green)';
    diffEl.textContent=`‚úÖ No discrepancy ‚Äî System (${sysQty}) matches physical count (${physical})`;
    reasonGroup.style.display='none';
  } else {
    diffEl.style.background='#3a1a1a';diffEl.style.color='var(--red)';
    diffEl.textContent=`‚ö†Ô∏è Discrepancy: System shows ${sysQty} cases, physical count is ${physical} cases (${diff>0?'+':''}${diff})`;
    reasonGroup.style.display='block';
  }
}

async function saveWarehouseAudit(){
  const product=g('audit-product')?.value||'';
  const date=g('audit-prod-date')?.value||'';
  const physical=parseFloat(g('audit-physical-count')?.value);
  const auditedBy=gt('audit-by');
  if(!product||!date){showToast('‚ö† Select a product and date',true);return;}
  if(isNaN(physical)){showToast('‚ö† Enter actual physical count',true);return;}
  if(!auditedBy){showToast('‚ö† Enter audited by name',true);return;}
  const stockMap=buildStockMap();
  const sysQty=stockMap[`${product}||${date}`]||0;
  const diff=physical-sysQty;
  const reason=gt('audit-reason');
  if(diff!==0&&!reason){showToast('‚ö† Provide a reason for the discrepancy',true);return;}
  const auditEntry={
    product,production_date:date,system_qty:sysQty,physical_qty:physical,
    discrepancy:diff,reason:reason||'No discrepancy',audited_by:auditedBy,
    audited_at:new Date().toISOString()
  };
  showLoading('Saving audit‚Ä¶');
  try{
    const saved=await SB.insert('warehouse_audits',auditEntry);
    warehouseAudits.unshift({...auditEntry,id:saved[0]?.id||Date.now()});
    // Write to audit log too
    await writeAudit({action:'WAREHOUSE_AUDIT',record_type:'Warehouse Audit',record_date:date,changed_by:auditedBy,diff:`${product} ${date}: System ${sysQty} ‚Üí Physical ${physical} (Œî${diff>0?'+':''}${diff}). Reason: ${reason||'none'}`,changed_at:new Date().toISOString()});
    // Reset form
    g('audit-product').value='';g('audit-prod-date').innerHTML='<option value="">‚Äî Select product first ‚Äî</option>';
    g('audit-physical-count').value='';g('audit-by').value='';g('audit-reason').value='';
    g('audit-system-balance').style.display='none';
    g('audit-diff-display').style.display='none';g('audit-reason-group').style.display='none';
    renderWarehouseAuditLog();renderWarehouse();refreshDashboard();
    showToast(diff===0?'‚úÖ Audit logged ‚Äî no discrepancy':'‚ö†Ô∏è Discrepancy logged & inventory adjusted');
  }catch(err){showToast('‚ö† '+err.message,true);}
  finally{hideLoading();}
}

function renderWarehouseAuditLog(){
  const el=g('warehouse-audit-log');if(!el)return;
  if(!warehouseAudits.length){el.innerHTML='<div class="empty-state" style="padding:20px;"><div class="empty-icon">üîé</div><div class="empty-text">No audits yet</div></div>';return;}
  el.innerHTML=warehouseAudits.slice(0,20).map(a=>{
    const hasDisc=a.discrepancy!==0;
    const diffStr=a.discrepancy>0?`+${a.discrepancy}`:String(a.discrepancy);
    return`<div class="warehouse-item" style="border-color:${hasDisc?'var(--red)':'var(--green)'};">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <span class="warehouse-product" style="font-size:15px;">${a.product}</span>
        <span class="item-tag ${hasDisc?'red':'green'}">${hasDisc?`Œî${diffStr} cases`:'‚úì Match'}</span>
      </div>
      <div style="font-size:13px;color:var(--text2);">üìÖ ${a.production_date} ¬∑ System: ${a.system_qty} ¬∑ Physical: ${a.physical_qty}</div>
      ${hasDisc?`<div style="font-size:12px;color:var(--red);margin-top:4px;">Reason: ${a.reason}</div>`:''}
      <div style="font-size:11px;color:var(--text3);margin-top:4px;">By ${a.audited_by} ¬∑ ${a.audited_at?new Date(a.audited_at).toLocaleString():'‚Äî'}</div>
    </div>`;
  }).join('');
}

// Updated buildStockMap: applies warehouse audit adjustments
function buildStockMapWithAudits(){
  // Start with base stock
  const base=buildStockMap();
  // Apply the most recent audit for each product+date
  const applied={};
  warehouseAudits.slice().reverse().forEach(a=>{
    const key=`${a.product}||${a.production_date}`;
    if(!applied[key]&&a.discrepancy!==0){
      // Override: set to physical_qty regardless of what math says
      // We do this by injecting a synthetic "shipped" correction
      applied[key]=true;
      // If physical < system, treat difference as "adjusted shipped"
      // If physical > system, treat as negative shipment (return)
      // Simplest: just override the map value
      base[key]=Math.max(0,a.physical_qty);
    }
  });
  return base;
}

function refreshDiscrepancyBanner(){
  const banner=g('dash-discrepancy-banner');
  const list=g('dash-discrepancy-list');
  if(!banner||!list)return;
  const recent=warehouseAudits.filter(a=>a.discrepancy!==0).slice(0,5);
  if(!recent.length){banner.style.display='none';return;}
  banner.style.display='block';
  list.innerHTML=recent.map(a=>{
    const diff=a.discrepancy>0?`+${a.discrepancy}`:String(a.discrepancy);
    return`<span style="display:block;">‚Ä¢ ${a.product} (${a.production_date}): System ${a.system_qty} ‚Üí Physical ${a.physical_qty} <strong style="color:var(--red);">(Œî${diff})</strong> ‚Äî ${a.reason}</span>`;
  }).join('');
}

// ============================================================
// INIT
// ============================================================
async function init(){
  // Set today's date on all date fields
  const today=new Date().toISOString().split('T')[0];
  ['run-date','recv-date','ship-date','batch1-date','batch2-date','export-start','export-end'].forEach(id=>{const el=g(id);if(el)el.value=today;});

  // Initialize items container with one item row
  addItem();

  setSyncIndicator('syncing',t('syncConnecting'));
  showLoading(t('loadingDB'));
  try{
    [runs,receipts,shipments,batches,warehouseAudits]=await Promise.all([
      SB.get('production_runs','&limit=500'),
      SB.get('receipts','&limit=500'),
      SB.get('shipments','&limit=500'),
      SB.get('formula_batches','&limit=500'),
      SB.get('warehouse_audits','&limit=200').catch(()=>[])
    ]);
    // Parse JSON fields
    runs=runs.map(r=>({...r,items:JSON.parse(r.items_json||'[]'),totalCases:r.total_cases||0}));
    shipments=shipments.map(s=>({...s,items:JSON.parse(s.items_json||'[]'),totalCases:s.total_cases||0}));
    dbConnected=true;
    setSyncIndicator('ok',t('syncOk'));
  }catch(err){
    dbConnected=false;
    setSyncIndicator('err','‚ö† Offline');
    console.error('DB error:',err);
  }finally{
    hideLoading();
    g('loading-overlay').classList.add('hidden');
    g('lock-screen').classList.remove('hidden');
    refreshDashboard();
  applyTranslations();
  }
}

init();
</script>
</body>
</html>
